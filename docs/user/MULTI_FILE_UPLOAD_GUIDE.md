# 多表批量上传使用指南

## 🎯 功能概述

**多表批量上传功能**允许您一次性上传多个 Excel/CSV 文件，系统将：
1. 自动创建一个新的数据集
2. 将所有文件导入到 DuckDB 数据库
3. 使用 AI 分析表之间的关联关系
4. 生成可视化的 ER 图
5. 支持自然语言查询分析

---

## 📍 功能入口

### 方式一：数据集管理页面（推荐）

1. 访问左侧导航栏 → **数据集管理**
2. 点击右上角的 **"批量上传多表"** 按钮（紫色按钮）

![入口位置](./images/multi-upload-entry.png)

### 方式二：直接访问

浏览器地址栏输入：
```
http://localhost:3000/datasets/multi-upload
```

---

## 📤 上传步骤

### 第一步：输入数据集名称

在"数据集名称"输入框中填写一个有意义的名称，例如：
- ✅ `订单分析数据集`
- ✅ `2025年销售数据`
- ✅ `客户行为分析`

### 第二步：选择文件

支持两种方式：

**拖拽上传**：
- 从文件管理器直接拖拽多个文件到上传区域

**点击选择**：
- 点击上传区域，在弹出的文件选择器中选择多个文件（按住 Ctrl/Cmd 多选）

### 第三步：文件预览

上传区域下方会显示已选择的文件列表，包括：
- 文件名
- 文件大小
- 表名预览（系统自动生成）

可以删除不需要的文件。

### 第四步：开始上传

点击底部的 **"开始上传并分析"** 按钮（蓝色按钮）

---

## 📋 文件要求

| 项目 | 要求 |
|------|------|
| **格式** | Excel (.xlsx, .xls) 或 CSV (.csv) |
| **大小** | 单个文件不超过 20MB |
| **数量** | 一次最多上传 10 个文件 |
| **内容** | 至少上传 2 个文件才能进行关系分析 |

---

## 🔄 上传流程

上传后系统会自动进行以下操作：

```mermaid
graph LR
    A[上传文件] --> B[解析数据]
    B --> C[导入 DuckDB]
    C --> D[AI 分析关系]
    D --> E[Vanna 训练]
    E --> F[完成]
```

**预计耗时**：
- 小文件（< 1MB）：10-30 秒
- 中等文件（1-10MB）：30-120 秒
- 大文件（> 10MB）：2-5 分钟

---

## ✅ 上传结果

上传成功后会显示：

### 成功信息
- ✅ 数据集 ID
- ✅ 数据集名称
- ✅ 数据源 ID
- ✅ 每个文件的导入结果（表名、行数、列数）

### 失败信息（如果有）
- ❌ 文件名
- ❌ 失败原因
- ⚠️ 错误提示

---

## 🔍 后续操作

### 1. 查看关系分析

上传完成后，回到**数据集管理**页面，找到新创建的数据集，点击 **"建模"** 按钮：

```
数据集卡片 → 建模按钮 → 可视化 ER 图
```

您将看到：
- 所有表的结构（字段、类型）
- AI 推荐的表关系（虚线显示）
- 关系的置信度和理由

### 2. 确认或修正关系

在 ER 图界面：
- ✅ **确认关系**：点击 AI 推荐的连线，选择"确认"
- ❌ **删除关系**：点击连线，选择"删除"
- ➕ **手动添加**：拖拽创建新的连线，选择字段和 JOIN 类型

### 3. 开始问答

关系确认后，点击 **"开始问答"** 按钮，进入智能问答界面：

**示例问题**：
```
- 查询上个月销售额最高的前 10 个客户
- 统计每个产品的订单数量
- 分析不同地区的客户分布
```

---

## 💡 最佳实践

### 文件命名建议

✅ **推荐命名**：
- `订单表.xlsx` → 表名：`订单表`
- `customers.csv` → 表名：`customers`
- `2025_销售数据.xlsx` → 表名：`2025_销售数据`

❌ **避免使用**：
- `数据 (1) - 副本.xlsx` → 特殊字符会被替换
- `文件.csv` → 名称不够明确

### 表结构建议

为了提高 AI 分析准确率，建议：

1. **使用清晰的字段名**：
   - ✅ `customer_id`、`订单编号`
   - ❌ `col1`、`字段A`

2. **外键字段命名规范**：
   - ✅ `orders.customer_id` 关联 `customers.id`
   - ✅ `订单表.客户ID` 关联 `客户表.ID`

3. **保持数据一致性**：
   - 关联字段的数据类型应相同（如都是整数）
   - 外键值应存在于主表中

---

## 🐛 常见问题

### Q1: 上传后看不到数据集？

**A**: 请等待训练完成（状态变为"已完成"）。可以点击 **"查看进度"** 查看训练状态。

### Q2: AI 没有识别到表关系？

**A**: 可能原因：
- 字段名差异过大（如 `id` vs `编号`）
- 数据重合度低（外键值不匹配）
- 数据类型不兼容

**解决方案**：手动在 ER 图中添加关系。

### Q3: 上传失败怎么办？

**A**: 检查：
1. 文件格式是否正确（.xlsx, .xls, .csv）
2. 文件大小是否超过 20MB
3. 文件是否损坏或被其他程序占用
4. 数据集名称是否已填写

### Q4: 如何删除上传的数据集？

**A**: 在数据集卡片上点击 **"更多"** 按钮（三个点） → 选择 **"删除"**。

---

## 🎓 使用示例

### 场景：电商订单分析

**数据文件**：
1. `orders.xlsx` - 订单表（order_id, customer_id, product_id, amount）
2. `customers.csv` - 客户表（id, name, city）
3. `products.xlsx` - 产品表（id, name, category, price）

**操作步骤**：

1. **上传文件**
   - 数据集名称：`2025年电商订单分析`
   - 选择 3 个文件并上传

2. **等待处理**（约 60 秒）
   - 系统导入 3 个表到 DuckDB
   - AI 分析推荐关系：
     - `orders.customer_id` → `customers.id` (置信度：high, 98.5% 重合)
     - `orders.product_id` → `products.id` (置信度：high, 95.2% 重合)

3. **确认关系**
   - 进入建模页面
   - 确认 AI 推荐的 2 个关系

4. **开始分析**
   - 提问："查询购买次数最多的前 10 位客户"
   - 系统自动生成 SQL 并返回结果

---

## 📊 技术架构

```
Frontend (Vue 3)
    ↓
Upload API (/upload/multiple)
    ↓
FastAPI Backend
    ↓
DuckDB Storage (独立 .db 文件)
    ↓
AI Relationship Analyzer (规则 + LLM)
    ↓
Vanna Training (ChromaDB)
    ↓
Ready for Query! 🎉
```

---

## 📞 技术支持

如果遇到问题，请：
1. 查看后端日志：`backend/logs/app.log`
2. 检查浏览器控制台错误
3. 联系技术支持团队

---

**祝您使用愉快！** 🚀

---

**文档版本**: v1.0  
**最后更新**: 2026-01-09
