

# Universal BI - 功能迭代开发清单

**版本**: v2.0

**目标**: 实现即席分析 (Excel)、深度归因分析、语义指标管理及智能交互。

---

## 📅 阶段一：即席分析与数据接入扩展 (Ad-hoc Analysis)

本阶段核心目标是降低用户使用门槛，支持无数据库环境下的 Excel/CSV 直接分析，并建立基础的语义层。

### 1.1 Excel/CSV 文件一键分析

**业务价值**: 允许用户上传本地表格文件，无需配置数据库即可进行 ChatBI 问答。

* **功能逻辑**:
1. **文件上传**:
* 前端提供文件上传入口（支持 `.xlsx`, `.csv`）。
* 限制文件大小（如 20MB）和行数（如 50,000 行）。


2. **自动入库 (ETL)**:
* 后端接收文件，读取 Header 自动识别字段类型。
* 将数据清洗后写入 PostgreSQL 的专用 Schema（如 `user_uploads`）。
* 自动生成唯一的物理表名（例如 `upload_{user_id}_{timestamp}`）。


3. **自动化训练**:
* 系统自动为该表创建一个新的 `Dataset` 记录。
* 自动触发 Vanna 训练流程（提取 DDL、训练列名注释）。


4. **状态反馈**:
* 上传完成后，直接跳转至 Chat 界面，并发送欢迎语“已加载表格 [文件名]，您可以直接提问了”。





### 1.2 语义层：计算指标定义 (Semantic Metrics)

**业务价值**: 让 AI 理解业务专属名词（如“毛利率”、“客单价”），而非仅依赖数据库字段。

* **功能逻辑**:
1. **可视化定义**:
* 在可视化建模 (VueFlow) 界面，选中表节点，支持“添加计算指标”。


2. **指标属性**:
* **指标名称**: 例如“客单价”。
* **计算公式**: SQL 表达式，例如 `SUM(gmv) / COUNT(DISTINCT user_id)`。
* **业务口径**: 自然语言描述，例如“统计周期内，平均每个付费用户的消费金额”。


3. **语义注入**:
* 保存时，系统将指标转化为自然语言 Prompt。
* 调用向量库训练接口，使 AI 在后续生成 SQL 时优先引用该公式。





### 1.3 数据集清理与管理

* **功能逻辑**:
* 针对上传的 Excel 数据集，提供显式的“删除”功能。
* 删除逻辑：级联删除 Dataset 记录 -> 清理向量库索引 -> `DROP TABLE` 物理表。



---

## 📅 阶段二：深度洞察与智能归因 (Deep Insight)

本阶段核心目标是让系统不仅返回“数据结果”，还能提供“分析结论”。

### 2.1 自动化统计特征计算

**业务价值**: 在 AI 介入前，通过统计算法发现数据的客观规律。

* **功能逻辑**:
1. **触发时机**: SQL 执行成功并获取到 DataFrame 后。
2. **计算引擎 (Python/Pandas)**:
* **数值列**: 计算 Sum, Avg, Max, Min, Variance (波动率)。
* **时间序列**: 如果包含日期列，计算 环比 (MoM) 和 同比 (YoY) 增长率。
* **异常检测**: 使用 IQR (四分位距) 算法标记异常高/低的数据点。


3. **输出**: 生成一份结构化的 `Stats Summary` 对象。



### 2.2 分析师 Agent (AI Insight)

**业务价值**: 模拟人类分析师，对数据波动进行归因和总结。

* **功能逻辑**:
1. **Prompt 构建**:
* 输入：用户原始问题 + SQL 逻辑 + 2.1 步骤生成的 `Stats Summary` + 前 5 行数据样本。
* 指令：“作为商业分析师，请解释数据趋势，指出异常点，并尝试给出业务归因。”


2. **生成报告**:
* LLM 输出一段 Markdown 格式的文本。


3. **前端展示**:
* 在图表下方渲染“智能分析”卡片。
* 支持折叠/展开，避免占用过多屏幕空间。





---

## 📅 阶段三：交互体验与可视化升级 (UX & Viz)

本阶段核心目标是提升对话的流畅度和图表的表现力。

### 3.1 智能图表推荐系统

**业务价值**: 摆脱固定的图表类型，根据数据形态自动选择最佳展示方式。

* **功能逻辑**:
1. **推荐算法 (后端)**:
* **趋势类**: 包含 `Date/Time` 类型字段 -> 推荐 **折线图 (Line)**。
* **构成类**: 包含 `Category` + `Value` 且分类数 < 8 -> 推荐 **饼图 (Pie)**。
* **对比类**: 包含 `Category` + `Value` 且分类数 >= 8 -> 推荐 **柱状图 (Bar)**。
* **明细类**: 多维度无聚合数据 -> 推荐 **表格 (Table)**。


2. **动态渲染 (前端)**:
* 组件接收 `chart_type` 参数自动切换 ECharts 配置。
* 提供“手动切换”工具栏，允许用户覆盖 AI 的推荐。





### 3.2 多轮对话上下文 (Context Awareness)

**业务价值**: 支持省略主语的连续追问，还原真实的人类对话习惯。

* **功能逻辑**:
1. **历史携带**: 前端请求时携带最近 3 轮对话记录 (`History List`)。
2. **查询重写 (Query Rewriting)**:
* 后端接收请求后，先调用 LLM 进行语义补全。
* 输入: `History` + `Current Query` (例如："按城市拆分")。
* 输出: `Rewritten Query` (例如："将上个月的销售额按城市拆分")。


3. **执行**: 使用重写后的 Query 进行 Vanna SQL 生成。



### 3.3 模糊查询澄清 (Clarification)

**业务价值**: 当用户提问含糊不清时，系统主动反问而非强行生成错误的 SQL。

* **功能逻辑**:
1. **置信度判断**: Vanna 内部判断 Schema 匹配度。
2. **反问触发**: 如果存在歧义（例如用户问“订单”，库里有“销售订单”和“采购订单”），LLM 生成澄清选项。
3. **交互**: 前端展示选项卡（Button Group），用户点击后自动补全问题发送。



---

## 📅 阶段四：数据消费与导出 (Export)

本阶段核心目标是让分析结果可以流转到系统外部。

### 4.1 分析结果导出

**业务价值**: 允许用户将 ChatBI 的结果用于汇报或进一步处理。

* **功能逻辑**:
1. **导出格式**: 支持 `.xlsx` (Excel) 和 `.csv`。
2. **流式下载**:
* 后端复用 Redis 缓存中的 SQL。
* 重新执行查询（或从缓存取 DataFrame）。
* 生成二进制流 (StreamingResponse) 返回前端。


3. **文件命名**: 自动以 `分析主题_时间戳.xlsx` 命名。



### 4.2 仪表盘深度集成

* **功能逻辑**:
* 支持将“Excel 导入数据集”生成的图表保存到仪表盘。
* 在仪表盘中保留“智能分析”的文字结论（快照模式）。



---

## ✅ 非功能性需求 (NFR)

1. **性能要求**:
* Excel 导入解析耗时 < 5秒 (针对 10MB 以内文件)。
* Redis 缓存命中时，接口响应时间 < 500ms。


2. **安全要求**:
* 用户上传的 Excel 数据必须物理隔离（Schema 级或表名前缀隔离）。
* 文件上传接口需进行后缀名与 MIME Type 双重校验。


3. **可观测性**:
* 全链路记录 `Request ID`。
* 记录“用户提问”到“SQL生成”再到“数据返回”的各阶段耗时。