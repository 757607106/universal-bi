# ChatBI 用户反馈指南

## 为什么需要反馈？

ChatBI 使用 AI 将自然语言转换为 SQL 查询。通过您的反馈，AI 可以**持续学习和改进**，生成更准确的查询结果。

每一次反馈都是在帮助 AI 变得更聪明！🧠

## 如何使用反馈功能

### 1. 查看 AI 回复

当您向 ChatBI 提问后，AI 会返回：
- 📊 **可视化图表**：数据的直观展示
- 🔍 **SQL 查询**：AI 生成的查询语句
- 💡 **智能分析**：业务洞察和总结

### 2. 找到反馈按钮

在每条 AI 回复的底部，您会看到**结果评价区域**：

```
结果评价：  👍 (点赞)    👎 (点踩)
```

### 3. 点赞正确的结果

**什么时候点赞？**
- ✅ 数据查询结果正确
- ✅ 图表展示符合预期
- ✅ SQL 逻辑清晰合理

**如何点赞？**
1. 点击 **👍 按钮**
2. 系统提示："感谢反馈！AI 已记住这个查询逻辑。"
3. 按钮变为绿色并禁用（防止重复提交）

**点赞的效果：**
- AI 会记住这个问题和对应的正确 SQL
- 下次遇到类似问题时，会优先使用这个逻辑
- 查询准确率持续提升 📈

---

### 4. 点踩错误的结果

**什么时候点踩？**
- ❌ 查询结果不正确
- ❌ SQL 逻辑有误
- ❌ 数据不符合业务需求

**如何点踩并修正？**

#### 步骤 1：点击 👎 按钮
点击 **👎 按钮** 后，会弹出"修正 SQL"对话框。

#### 步骤 2：修改 SQL
对话框中会**预填充当前的 SQL**，您可以直接修改：

```sql
-- 原始 SQL（可能有错误）
SELECT * FROM orders

-- 修正后的 SQL（您提供的正确版本）
SELECT * FROM orders WHERE status = 'completed'
```

**提示**：
- 请确保修正后的 SQL **语法正确**
- SQL 逻辑应符合**业务需求**
- 可以参考数据库表结构和字段名

#### 步骤 3：提交修正
点击"**提交修正**"按钮：
1. 系统提示："感谢你的修正！AI 已学习了正确的 SQL。"
2. 按钮变为红色并禁用
3. AI 学习了正确的查询逻辑

**点踩的效果：**
- AI 会学习**您提供的正确 SQL**
- 避免在未来重复犯错
- 帮助 AI 理解业务规则 🎯

---

## 反馈流程示意图

```
┌─────────────────┐
│  用户提问       │
│ "查询订单总数"  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  AI 生成结果    │
│ SQL + 图表      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│ 👍    │ │ 👎    │
│ 点赞  │ │ 点踩  │
└───┬───┘ └───┬───┘
    │         │
    │         ▼
    │   ┌─────────────┐
    │   │ 修正 SQL    │
    │   │ 对话框      │
    │   └─────┬───────┘
    │         │
    │         ▼
    │   ┌─────────────┐
    │   │ 提交修正    │
    │   └─────┬───────┘
    │         │
    └─────┬───┘
          │
          ▼
    ┌─────────────┐
    │ AI 学习训练 │
    │ 记住正确逻辑│
    └─────────────┘
```

---

## 常见问题（FAQ）

### Q1: 点赞后还能修改吗？

**不能**。一旦点赞或点踩，按钮会变为禁用状态，防止重复反馈。

**为什么？**
- 避免训练数据冲突（同一问题既点赞又点踩）
- 确保反馈的一致性和可靠性

**解决方案**：
- 如果发现反馈错误，可以重新提问并重新反馈
- 后续版本可能支持撤销反馈功能

---

### Q2: 点踩后必须提供修正 SQL 吗？

**是的**（强烈建议）。

**如果不提供修正 SQL：**
- 关闭对话框：系统**不会记录任何反馈**
- AI **无法学习**到正确的逻辑

**如果提供修正 SQL：**
- AI 会学习正确的查询方式
- 避免未来重复犯错

---

### Q3: 我不懂 SQL，能使用反馈功能吗？

**可以使用点赞功能！** 👍

**点赞场景**：
- 当查询结果正确时，点击 👍 即可
- 无需理解 SQL 语法

**点踩场景**：
- 如果不懂 SQL，可以选择：
  - **仅点踩**：不提供修正 SQL，直接关闭对话框（不会触发训练）
  - **联系管理员**：让懂 SQL 的同事帮忙修正

**建议**：
- 团队内至少有 1-2 人懂 SQL，负责高质量反馈
- 普通用户负责点赞正确结果

---

### Q4: 反馈后多久生效？

**立即生效！** ⚡

反馈提交后：
1. AI 立即将问答对存入向量库
2. 系统自动清理查询缓存
3. 下次提问时，会优先使用训练过的逻辑

**验证方式**：
- 提交反馈后，等待 2-3 秒
- 再次提问相同或相似的问题
- 观察 AI 是否生成正确的 SQL

---

### Q5: 反馈会影响其他用户吗？

**取决于数据集类型：**

**私有数据集**（您创建的）：
- 只有您能看到和训练
- 反馈仅影响您的数据集

**公共数据集**（管理员创建的）：
- 只有**超级管理员**能训练
- 普通用户无法提交反馈（会提示权限不足）

---

### Q6: 如何查看我提交过的反馈？

**当前版本**：
- 反馈提交后，按钮会变色（绿色=点赞，红色=点踩）
- 页面刷新后状态会丢失（仅前端记录）

**未来版本可能支持**：
- 反馈历史记录
- 反馈统计面板（点赞率、准确率等）
- 训练数据管理界面

---

## 最佳实践

### 💡 技巧 1：高频问题优先反馈

**建议**：
- 对每天都会用到的查询及时反馈
- 核心业务场景优先训练
- 边缘案例可以延后

**示例**：
- ✅ "查询今日销售额"（高频）→ 优先反馈
- ⚠️ "查询 2020 年春节期间的退货率"（低频）→ 可以延后

---

### 💡 技巧 2：组合反馈提升覆盖率

**场景**：AI 对时间范围查询不准确

**训练策略**：
1. 提问："最近 7 天的销售额"→ 点赞正确结果
2. 提问："最近 30 天的订单量"→ 点赞正确结果
3. 提问："本月的用户注册数"→ 点赞正确结果

**效果**：
- AI 学会了多种时间范围表达方式
- 提升泛化能力

---

### 💡 技巧 3：修正 SQL 时保持简洁

**不推荐**（过度复杂）：
```sql
SELECT 
  DATE_FORMAT(o.created_at, '%Y-%m-%d') as date,
  COUNT(DISTINCT o.id) as order_count,
  SUM(o.amount) as total_amount,
  AVG(o.amount) as avg_amount,
  COUNT(DISTINCT o.user_id) as user_count
FROM orders o
LEFT JOIN users u ON o.user_id = u.id
WHERE o.status = 'completed'
  AND o.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
  AND u.vip_level >= 3
GROUP BY DATE_FORMAT(o.created_at, '%Y-%m-%d')
ORDER BY date DESC
```

**推荐**（简洁清晰）：
```sql
SELECT COUNT(*) as total FROM orders WHERE status = 'completed'
```

**为什么？**
- 简洁的 SQL 更通用，适用场景更广
- AI 容易学习和应用
- 复杂查询可以拆分为多个简单问题

---

### 💡 技巧 4：团队协作提升质量

**建议**：
1. **分工明确**：
   - 业务人员负责提问和点赞
   - 技术人员负责修正 SQL

2. **定期复盘**：
   - 每周查看 AI 的表现
   - 讨论哪些查询需要优化
   - 统一反馈标准

3. **知识沉淀**：
   - 记录常见问题的标准 SQL
   - 新人培训时参考已训练的问答对

---

## 反馈示例

### 示例 1：查询订单总数

**用户提问**：
```
今天的订单有多少个？
```

**AI 生成结果**：
```sql
SELECT COUNT(*) as order_count 
FROM orders 
WHERE DATE(created_at) = CURDATE()
```

**用户操作**：
- ✅ 结果正确 → 点击 👍 点赞

**系统提示**：
```
感谢反馈！AI 已记住这个查询逻辑。
```

---

### 示例 2：修正时间范围错误

**用户提问**：
```
最近 7 天的销售额
```

**AI 生成结果（错误）**：
```sql
SELECT SUM(amount) FROM orders WHERE created_at > NOW() - 7
```
> ❌ 语法错误：应该是 `INTERVAL 7 DAY`

**用户操作**：
1. 点击 👎 点踩
2. 在对话框中修改 SQL：
   ```sql
   SELECT SUM(amount) FROM orders 
   WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
   ```
3. 点击"提交修正"

**系统提示**：
```
感谢你的修正！AI 已学习了正确的 SQL。
```

---

### 示例 3：修正业务逻辑错误

**用户提问**：
```
显示所有 VIP 客户
```

**AI 生成结果（业务逻辑错误）**：
```sql
SELECT * FROM users WHERE is_vip = 1
```
> ❌ 业务规则：VIP 应该是 `vip_level >= 3`，而不是 `is_vip` 字段

**用户操作**：
1. 点击 👎 点踩
2. 在对话框中修改 SQL：
   ```sql
   SELECT * FROM users WHERE vip_level >= 3
   ```
3. 点击"提交修正"

**效果**：
- AI 学习到 VIP 客户的正确定义
- 未来查询 VIP 相关数据时会使用正确逻辑

---

## 总结

### 🎯 核心要点

1. **点赞正确结果**：帮助 AI 记住好的查询逻辑
2. **点踩错误结果**：提供正确 SQL 让 AI 学习改进
3. **立即生效**：反馈提交后立即训练，无需等待
4. **持续改进**：每次反馈都在提升 AI 的准确率

### 📈 反馈的价值

| 反馈次数 | AI 准确率 | 用户体验 |
|---------|----------|---------|
| 0-10 次  | ⭐⭐⭐     | 一般    |
| 10-50 次 | ⭐⭐⭐⭐   | 良好    |
| 50+ 次   | ⭐⭐⭐⭐⭐ | 优秀    |

**建议**：
- 项目初期积极反馈（目标：50+ 次）
- 成熟期仅在出现新问题时反馈

---

### 🙏 感谢您的反馈

每一次反馈都是对 ChatBI 的贡献！

通过您的帮助，AI 会变得越来越聪明，为整个团队带来更好的数据分析体验。

**有问题？**
- 联系系统管理员
- 查看技术文档：`docs/backend/FEEDBACK_RLHF.md`
