# 密钥轮换指南

## 概述

本系统使用 `SECRET_KEY` 加密敏感数据（如数据源密码）。如果需要更换密钥（密钥泄露、定期轮换等），请按照本指南操作，避免导致已加密数据无法解密。

## 密钥用途

`SECRET_KEY` 用于以下场景：
1. **JWT Token 签名**：用户登录认证
2. **数据源密码加密**：保护数据库连接密码

## 密钥轮换步骤

### 方案1: 使用旧密钥列表（推荐）

此方案允许系统在解密失败时自动尝试旧密钥，实现平滑过渡。

#### 步骤1: 配置旧密钥

在 `.env` 文件中，将当前 `SECRET_KEY` 添加到 `OLD_SECRET_KEYS` 列表：

```env
# 当前密钥（即将更换）
SECRET_KEY=old_key_that_needs_rotation

# 旧密钥列表（用逗号分隔）
OLD_SECRET_KEYS=old_key_that_needs_rotation
```

#### 步骤2: 生成新密钥

使用 `openssl` 生成强随机密钥（至少32字符）：

```bash
openssl rand -hex 32
```

示例输出：
```
a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
```

#### 步骤3: 更新 SECRET_KEY

将新密钥设置为 `SECRET_KEY`：

```env
# 新密钥
SECRET_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2

# 旧密钥列表（保留旧密钥，以便解密旧数据）
OLD_SECRET_KEYS=old_key_that_needs_rotation
```

#### 步骤4: 重启服务

```bash
# Docker 环境
docker-compose restart backend

# 本地环境
# 重启 uvicorn 进程
```

#### 步骤5: 验证

1. **测试登录**：确保现有用户可以正常登录（JWT 使用新密钥签名）
2. **测试数据源连接**：
   - 打开已有数据源，点击「测试连接」
   - 系统会使用旧密钥解密密码，连接应成功
   - 如果失败，检查 `OLD_SECRET_KEYS` 是否配置正确

#### 步骤6: 重新加密旧数据（可选但推荐）

旧数据仍使用旧密钥加密。为了完全移除旧密钥依赖，需要重新加密：

```bash
# 运行重新加密脚本（需要开发）
python scripts/re_encrypt_datasources.py
```

**脚本逻辑：**
1. 读取所有数据源的加密密码
2. 使用旧密钥解密
3. 使用新密钥重新加密
4. 更新数据库

重新加密完成后，可以移除 `OLD_SECRET_KEYS` 配置：

```env
SECRET_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
OLD_SECRET_KEYS=  # 清空
```

---

### 方案2: 手动重置所有数据源密码（不推荐）

如果不配置 `OLD_SECRET_KEYS`，更换密钥后所有数据源密码将无法解密。

此时用户需要手动「重新连接」每个数据源：

1. 打开数据源管理页面
2. 对每个数据源，点击「重新连接」
3. 输入新密码并保存

**缺点：**
- 用户体验差
- 需要手动操作所有数据源
- 可能遗忘部分数据源

---

## 最佳实践

### 1. 初始部署时设置强密钥

生产环境首次部署时，务必设置强随机密钥：

```bash
# 生成 32 字节（64 字符）密钥
openssl rand -hex 32
```

将生成的密钥添加到 `.env`：

```env
SECRET_KEY=your_generated_key_here
```

### 2. 定期轮换密钥

建议每 6-12 个月轮换一次密钥，或在以下情况下立即轮换：
- 密钥泄露
- 员工离职
- 安全审计要求

### 3. 密钥存储安全

- ❌ **不要**将密钥提交到 Git 仓库
- ❌ **不要**在代码中硬编码密钥
- ✅ **使用**环境变量或密钥管理服务（AWS KMS, HashiCorp Vault）
- ✅ **使用** `.gitignore` 忽略 `.env` 文件

### 4. 备份旧密钥

在轮换密钥前，务必备份旧密钥到安全位置（加密存储），以备不时之需。

---

## 故障排查

### 问题1: 数据源连接失败，提示"密码无法解密"

**原因：**
- 密钥已更改，但未配置 `OLD_SECRET_KEYS`

**解决方案：**
1. 将旧密钥添加到 `OLD_SECRET_KEYS`
2. 重启服务
3. 测试连接

### 问题2: 用户无法登录

**原因：**
- JWT Token 使用旧密钥签名，新密钥无法验证

**解决方案：**
- 用户需要重新登录（旧 Token 失效）
- 系统会使用新密钥签发新 Token

### 问题3: 旧密钥列表太长

**原因：**
- 多次轮换密钥，未清理旧密钥

**解决方案：**
1. 运行重新加密脚本，将所有数据迁移到新密钥
2. 清空 `OLD_SECRET_KEYS`

---

## 相关文件

- **配置文件**: `backend/app/core/config.py`
- **加密模块**: `backend/app/core/security.py`
- **数据源管理**: `backend/app/api/v1/endpoints/datasource.py`

---

## 安全警告

⚠️ **密钥丢失后果**：
- 所有已加密的数据源密码无法恢复
- 用户需要手动重新设置所有数据源密码

⚠️ **密钥泄露后果**：
- 攻击者可以解密所有数据源密码
- 攻击者可以伪造 JWT Token

如发现密钥泄露，请立即：
1. 轮换密钥（按照上述步骤）
2. 检查系统日志，排查异常访问
3. 通知所有用户更改密码
4. 考虑重置所有数据源密码

---

## 未来改进

- [ ] 实现自动重新加密脚本
- [ ] 集成 AWS KMS / HashiCorp Vault
- [ ] 支持密钥版本管理
- [ ] 定期密钥轮换提醒
