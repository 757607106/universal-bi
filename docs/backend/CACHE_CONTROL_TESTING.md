# 缓存控制功能测试指南

## 功能概述

本次更新在 Chat 接口中集成了缓存控制功能，包括：
1. **缓存标识**：在 AI 回复中显示 ⚡ Cached 标识
2. **强制刷新**：通过"重新生成"按钮禁用缓存重新查询

## 后端更新

### 1. ChatRequest Schema
```python
class ChatRequest(BaseModel):
    dataset_id: int
    question: str
    use_cache: bool = True  # 是否使用缓存，默认启用
```

### 2. Chat API 端点
```python
result = await VannaManager.generate_result(
    dataset_id=request.dataset_id,
    question=request.question,
    db_session=db,
    use_cache=request.use_cache  # 传递缓存控制参数
)
```

## 前端更新

### 1. API 更新
```typescript
export const sendChat = async (data: { 
  dataset_id: number, 
  question: string, 
  use_cache?: boolean  // 新增可选参数
}) => {
  // ...
}
```

### 2. UI 更新

#### 缓存标识
- **位置**：AI 消息气泡右上角
- **显示条件**：`msg.isCached === true`
- **样式**：⚡ Lightning 图标 + "Cached" 文本
- **颜色**：黄色渐变背景

#### 重新生成按钮
- **位置**：SQL 详情折叠面板中，点赞/点踩按钮旁边
- **图标**：🔄 Refresh
- **功能**：调用 API 时设置 `use_cache: false`

## 测试步骤

### 测试 1：缓存命中标识

**步骤**：
1. 启动后端服务（确保 Redis 已启动）
2. 打开前端 Chat 页面
3. 选择一个数据集
4. 输入问题：`查询用户总数`
5. 等待 AI 响应

**预期结果**：
- 第一次查询：消息气泡**无**缓存标识
- 第二次相同查询：消息气泡**显示**⚡ Cached 标识
- 响应速度：第二次明显快于第一次（约 5-10 倍）

**验证点**：
- [ ] 缓存标识显示在消息气泡右上角
- [ ] 缓存标识样式正确（黄色渐变背景 + Lightning 图标）
- [ ] 第二次查询速度明显提升

### 测试 2：强制刷新功能

**步骤**：
1. 在测试 1 的基础上，已有缓存的查询结果
2. 展开 SQL 详情面板
3. 点击"重新生成"按钮
4. 等待 AI 响应

**预期结果**：
- 按钮显示 loading 状态
- AI 重新生成 SQL 并执行查询
- 新消息**无**缓存标识
- 提示"已重新生成"

**验证点**：
- [ ] 重新生成按钮正常工作
- [ ] 生成过程中按钮显示 loading 状态
- [ ] 重新生成后无缓存标识
- [ ] 成功提示消息显示

### 测试 3：缓存禁用场景

**步骤**：
1. 在浏览器开发者工具中监控网络请求
2. 输入问题并发送
3. 检查请求 payload

**预期结果**：
- 默认请求包含 `"use_cache": true`
- 重新生成请求包含 `"use_cache": false`

**验证点**：
- [ ] 默认请求参数正确
- [ ] 重新生成请求参数正确

### 测试 4：不同问题的缓存隔离

**步骤**：
1. 输入问题 A：`查询用户总数`（等待响应）
2. 输入问题 B：`查询订单总数`（等待响应）
3. 再次输入问题 A：`查询用户总数`

**预期结果**：
- 第 1 次问题 A：无缓存标识
- 问题 B：无缓存标识
- 第 2 次问题 A：显示缓存标识

**验证点**：
- [ ] 不同问题的缓存互不干扰
- [ ] 相同问题命中缓存

### 测试 5：缓存过期测试

**步骤**：
1. 输入问题并等待响应（有缓存标识）
2. 等待 25 小时（或修改 TTL 为 10 秒测试）
3. 再次输入相同问题

**预期结果**：
- 缓存过期后，无缓存标识
- 后端重新生成 SQL

**验证点**：
- [ ] 缓存 TTL 正确（24小时）
- [ ] 过期后重新生成

### 测试 6：Redis 不可用降级

**步骤**：
1. 停止 Redis 服务
2. 输入问题并发送

**预期结果**：
- 系统正常工作
- 无缓存标识
- 后台日志显示 Redis 不可用警告

**验证点**：
- [ ] 系统优雅降级
- [ ] 不影响正常查询功能
- [ ] 日志记录正确

## 性能指标

### 缓存命中效果
- **首次查询**：约 3-5 秒（含 LLM 生成 + SQL 执行）
- **缓存命中**：约 0.3-0.5 秒（仅 SQL 执行）
- **性能提升**：约 **6-10 倍**

### 缓存 Key 格式
```
bi:sql_cache:{md5_hash}
```

### 缓存内容
只缓存生成的 SQL 字符串，不缓存查询结果。

## 故障排查

### 问题 1：缓存标识不显示

**可能原因**：
- Redis 未启动
- 后端返回的 `is_cached` 字段为 false
- 前端未正确读取字段

**排查步骤**：
1. 检查 Redis 服务状态：`redis-cli ping`
2. 检查浏览器开发者工具中 API 响应
3. 检查后端日志

### 问题 2：重新生成按钮不工作

**可能原因**：
- 消息对象缺少 `question` 或 `datasetId` 字段
- API 请求失败

**排查步骤**：
1. 检查浏览器控制台错误信息
2. 检查网络请求状态
3. 检查后端日志

### 问题 3：缓存未过期但未命中

**可能原因**：
- 问题文本略有差异（空格、标点）
- Redis 数据被清除

**排查步骤**：
1. 确认问题文本完全一致
2. 使用 `redis-cli` 检查键是否存在：`KEYS bi:sql_cache:*`

## 最佳实践

### 用户使用建议
1. **日常查询**：使用默认缓存，享受快速响应
2. **数据更新后**：使用"重新生成"获取最新结果
3. **测试新逻辑**：使用"重新生成"验证 AI 理解

### 开发者建议
1. **监控缓存命中率**：定期检查 Redis 日志
2. **调整 TTL**：根据业务需求调整缓存过期时间
3. **清理策略**：数据集重新训练时自动清除缓存

## 未来优化方向

1. **缓存命中率统计**：在前端展示缓存命中率
2. **批量清除**：支持按数据集或时间范围清除缓存
3. **智能预热**：训练完成后自动生成常见查询的缓存
4. **缓存版本管理**：数据集版本变更时自动失效相关缓存
