# 环境变量与配置

<cite>
**本文引用的文件**
- [.env.example](file://.env.example)
- [docker-compose.yml](file://docker-compose.yml)
- [backend/app/core/config.py](file://backend/app/core/config.py)
- [backend/app/main.py](file://backend/app/main.py)
- [backend/app/core/security.py](file://backend/app/core/security.py)
- [backend/app/db/session.py](file://backend/app/db/session.py)
- [QUICKSTART.md](file://QUICKSTART.md)
- [README.md](file://README.md)
- [backend/tests/manual_scripts/test_redis_cache.py](file://backend/tests/manual_scripts/test_redis_cache.py)
- [backend/example_redis_cache.py](file://backend/example_redis_cache.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本指南系统性地解释了 .env.example 文件中的所有配置项，涵盖应用基础配置、JWT 安全配置、主数据库连接、AI 模型配置、缓存配置以及向量数据库配置。同时详细说明了 Docker Compose 中端口映射与密码配置的继承关系，并提供敏感信息保护建议与生产环境最佳实践。最后演示了从 .env.example 创建和修改 .env 文件的完整流程。

## 项目结构
该项目采用前后端分离架构，后端使用 FastAPI + SQLAlchemy，前端使用 Vue 3 + TypeScript。配置管理采用统一的环境变量机制，所有配置项从 .env 文件读取并在运行时注入到应用中。

```mermaid
graph TB
subgraph "配置层"
ENV[".env 环境变量文件"]
EX[".env.example 模板文件"]
end
subgraph "后端应用"
CFG["Settings 配置类<br/>backend/app/core/config.py"]
MAIN["FastAPI 应用入口<br/>backend/app/main.py"]
SEC["安全与认证<br/>backend/app/core/security.py"]
DB["数据库会话<br/>backend/app/db/session.py"]
end
subgraph "容器编排"
DC["Docker Compose<br/>docker-compose.yml"]
MYSQL["MySQL 服务"]
PG["PostgreSQL 服务"]
REDIS["Redis 服务"]
BACKEND["后端 API 服务"]
FRONTEND["前端 Web 服务"]
end
EX --> ENV
ENV --> CFG
CFG --> MAIN
CFG --> SEC
CFG --> DB
ENV --> DC
DC --> MYSQL
DC --> PG
DC --> REDIS
DC --> BACKEND
DC --> FRONTEND
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L141)
- [backend/app/core/config.py](file://backend/app/core/config.py#L1-L51)
- [backend/app/main.py](file://backend/app/main.py#L1-L35)

**章节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L141)
- [backend/app/core/config.py](file://backend/app/core/config.py#L1-L51)
- [backend/app/main.py](file://backend/app/main.py#L1-L35)

## 核心组件
本项目的配置体系围绕以下核心组件构建：

### 配置类 Settings
Settings 类是整个应用的配置中心，所有配置项都从 .env 文件读取并提供默认值。该类使用 Pydantic Settings 进行类型验证和环境变量绑定。

### 环境变量文件
.env.example 提供完整的配置模板，包含所有必要的配置项及其用途说明。实际部署时应复制为 .env 并根据环境调整具体值。

### Docker Compose 配置
docker-compose.yml 定义了完整的微服务架构，包括数据库、缓存和应用服务，并实现了配置的继承与传递。

**章节来源**
- [backend/app/core/config.py](file://backend/app/core/config.py#L5-L49)
- [.env.example](file://.env.example#L1-L72)
- [docker-compose.yml](file://docker-compose.yml#L1-L141)

## 架构概览
系统采用分层架构设计，配置管理贯穿整个应用生命周期：

```mermaid
sequenceDiagram
participant User as "用户"
participant Frontend as "前端应用"
participant Backend as "后端 API"
participant Config as "配置系统"
participant DB as "数据库"
participant Cache as "缓存系统"
User->>Frontend : 访问应用
Frontend->>Backend : 发起请求
Backend->>Config : 读取配置
Config-->>Backend : 返回配置值
Backend->>DB : 执行数据库操作
Backend->>Cache : 缓存查询结果
Backend-->>Frontend : 返回响应
Frontend-->>User : 展示结果
```

**图表来源**
- [backend/app/main.py](file://backend/app/main.py#L11-L35)
- [backend/app/core/config.py](file://backend/app/core/config.py#L8-L43)
- [backend/app/db/session.py](file://backend/app/db/session.py#L6-L24)

## 详细组件分析

### 应用基础配置
应用基础配置决定了系统的整体行为和外观。

#### PROJECT_NAME
- **用途**：设置应用的显示名称
- **默认值**："Universal BI"
- **影响范围**：API 文档标题、应用标识
- **配置位置**：.env.example 第11行

#### API_V1_STR
- **用途**：设置 API 版本前缀
- **默认值**："/api/v1"
- **影响范围**：所有 API 端点的基础路径
- **配置位置**：.env.example 第12行

**章节来源**
- [.env.example](file://.env.example#L10-L12)
- [backend/app/core/config.py](file://backend/app/core/config.py#L8-L10)
- [backend/app/main.py](file://backend/app/main.py#L11-L14)

### JWT 安全配置
JWT 安全配置是系统认证授权的核心保障。

#### SECRET_KEY
- **用途**：JWT 签名密钥
- **默认值**："change_this_to_a_secure_random_key_in_production"
- **安全要求**：必须使用强随机密钥，长度至少 32 字节
- **生成方法**：`python -c "import secrets; print(secrets.token_urlsafe(32))"`
- **配置位置**：.env.example 第16行

#### ALGORITHM
- **用途**：JWT 签名算法
- **默认值**："HS256"
- **安全性**：对称加密算法，安全性取决于密钥强度
- **配置位置**：.env.example 第17行

#### ACCESS_TOKEN_EXPIRE_MINUTES
- **用途**：访问令牌过期时间（分钟）
- **默认值**：30
- **安全建议**：生产环境建议设置为更短时间（如 15-30 分钟）
- **配置位置**：.env.example 第18行

**章节来源**
- [.env.example](file://.env.example#L14-L18)
- [backend/app/core/config.py](file://backend/app/core/config.py#L12-L15)
- [backend/app/core/security.py](file://backend/app/core/security.py#L73-L80)

### 主数据库连接配置
主数据库配置支持多种数据库类型，提供灵活的连接选项。

#### SQLALCHEMY_DATABASE_URI
- **用途**：数据库连接字符串
- **默认值**：MySQL 连接（本地开发）
- **支持类型**：
  - MySQL: `mysql+pymysql://user:password@host:port/database?charset=utf8mb4`
  - PostgreSQL: `postgresql://user:password@host:port/database`
  - SQLite: `sqlite:///./sql_app.db`
- **配置位置**：.env.example 第22-27行

#### 数据库类型判断
应用根据连接字符串前缀自动选择数据库类型：
- SQLite：使用特殊连接参数
- MySQL/PostgreSQL：使用连接池配置

**章节来源**
- [.env.example](file://.env.example#L20-L27)
- [backend/app/core/config.py](file://backend/app/core/config.py#L17-L19)
- [backend/app/db/session.py](file://backend/app/db/session.py#L6-L24)

### AI 模型配置
AI 模型配置决定了系统使用的自然语言处理能力。

#### DASHSCOPE_API_KEY
- **用途**：阿里云 DashScope API 密钥
- **获取方式**：访问 https://dashscope.console.aliyun.com/apiKey
- **必填项**：必须配置才能使用 AI 功能
- **配置位置**：.env.example 第32行

#### QWEN_MODEL
- **用途**：通义千问模型版本
- **默认值**："qwen-max"
- **可用版本**：qwen-max、qwen-plus、qwen-turbo
- **性能特点**：qwen-max 在严格遵守指令方面表现更好
- **配置位置**：.env.example 第33行

**章节来源**
- [.env.example](file://.env.example#L29-L33)
- [backend/app/core/config.py](file://backend/app/core/config.py#L21-L24)

### 缓存配置
缓存配置提供了多层次的数据缓存策略。

#### REDIS_URL
- **用途**：Redis 缓存连接地址
- **默认值**："redis://localhost:6379/0"
- **密码配置**：`redis://:password@localhost:6379/0`
- **配置位置**：.env.example 第36行

#### 缓存 TTL 配置
- **REDIS_CACHE_TTL**：结果缓存过期时间（秒）
  - 默认值：300（5分钟）
  - 用途：缓存完整查询结果
  - 适用场景：极短期重复查询
- **SQL_CACHE_TTL**：SQL 缓存过期时间（秒）
  - 默认值：604800（7天）
  - 用途：缓存 SQL 语句
  - 适用场景：节省 Token 消耗，保持数据时效性

**章节来源**
- [.env.example](file://.env.example#L35-L39)
- [backend/app/core/config.py](file://backend/app/core/config.py#L26-L29)
- [backend/tests/manual_scripts/test_redis_cache.py](file://backend/tests/manual_scripts/test_redis_cache.py#L336-L337)

### 向量数据库配置
向量数据库配置支持 Vanna AI 的向量存储和检索功能。

#### VN_PG_HOST
- **用途**：PostgreSQL 主机地址
- **默认值**："localhost"
- **配置位置**：.env.example 第43行

#### VN_PG_PORT
- **用途**：PostgreSQL 端口号
- **默认值**：5432
- **配置位置**：.env.example 第44行

#### VN_PG_DB
- **用途**：向量数据库名称
- **默认值**："universal_bi_vector"
- **配置位置**：.env.example 第45行

#### VN_PG_USER
- **用途**：向量数据库用户名
- **默认值**："postgres"
- **配置位置**：.env.example 第46行

#### VN_PG_PASSWORD
- **用途**：向量数据库密码
- **默认值**："postgres"
- **配置位置**：.env.example 第47行

**章节来源**
- [.env.example](file://.env.example#L41-L47)
- [backend/app/core/config.py](file://backend/app/core/config.py#L31-L37)

### ChromaDB 配置
ChromaDB 是本地向量存储解决方案。

#### CHROMA_PERSIST_DIR
- **用途**：ChromaDB 持久化目录
- **默认值**："./chroma_db"
- **配置位置**：.env.example 第51行

#### CHROMA_N_RESULTS
- **用途**：向量检索返回结果数量
- **默认值**：10
- **配置位置**：.env.example 第52行

**章节来源**
- [.env.example](file://.env.example#L49-L52)
- [backend/app/core/config.py](file://backend/app/core/config.py#L39-L42)

### Docker Compose 端口映射与密码继承
Docker Compose 实现了配置的集中管理和继承。

#### 端口映射规则
- **MYSQL_PORT**：默认 3306，映射到宿主机端口
- **POSTGRES_PORT**：默认 5432，映射到宿主机端口  
- **REDIS_PORT**：默认 6379，映射到宿主机端口
- **BACKEND_PORT**：默认 8000，映射到宿主机端口
- **FRONTEND_PORT**：默认 3000，映射到宿主机端口

#### 密码继承机制
Docker Compose 通过环境变量继承实现密码共享：
- MySQL 密码：`${MYSQL_ROOT_PASSWORD:-root123456}`
- PostgreSQL 密码：`${POSTGRES_PASSWORD:-postgres123456}`
- Redis 密码：`${REDIS_PASSWORD}`（可选）

#### 服务间配置传递
后端服务通过环境变量接收数据库和缓存配置：
- SQLALCHEMY_DATABASE_URI：动态构建 MySQL 连接字符串
- REDIS_URL：动态构建 Redis 连接字符串
- VN_PG_*：直接继承 PostgreSQL 配置

**章节来源**
- [.env.example](file://.env.example#L54-L71)
- [docker-compose.yml](file://docker-compose.yml#L11-L16)
- [docker-compose.yml](file://docker-compose.yml#L36-L40)
- [docker-compose.yml](file://docker-compose.yml#L59-L61)
- [docker-compose.yml](file://docker-compose.yml#L86-L92)

## 依赖分析

```mermaid
graph TD
subgraph "配置依赖关系"
ENV[".env 环境变量"]
CFG["Settings 配置类"]
MAIN["FastAPI 应用"]
SEC["安全模块"]
DB["数据库模块"]
CACHE["缓存模块"]
end
subgraph "外部依赖"
MYSQL["MySQL 数据库"]
PG["PostgreSQL 数据库"]
REDIS["Redis 缓存"]
DASHSCOPE["DashScope API"]
end
ENV --> CFG
CFG --> MAIN
CFG --> SEC
CFG --> DB
CFG --> CACHE
MAIN --> MYSQL
MAIN --> PG
MAIN --> REDIS
SEC --> DASHSCOPE
CACHE --> REDIS
```

**图表来源**
- [backend/app/core/config.py](file://backend/app/core/config.py#L5-L49)
- [backend/app/main.py](file://backend/app/main.py#L1-L35)
- [backend/app/core/security.py](file://backend/app/core/security.py#L1-L161)
- [backend/app/db/session.py](file://backend/app/db/session.py#L1-L34)

**章节来源**
- [backend/app/core/config.py](file://backend/app/core/config.py#L5-L49)
- [backend/app/core/security.py](file://backend/app/core/security.py#L1-L161)
- [backend/app/db/session.py](file://backend/app/db/session.py#L1-L34)

## 性能考虑
缓存策略对系统性能有显著影响：

### 缓存层次结构
1. **结果缓存**（REDIS_CACHE_TTL=300秒）
   - 缓存完整查询结果
   - 适合极短期重复查询
   - 减少数据库和 AI 模型调用

2. **SQL 缓存**（SQL_CACHE_TTL=604800秒）
   - 缓存 SQL 语句并重新执行
   - 节省 Token 消耗
   - 保持数据时效性

### 性能优化建议
- 根据业务场景调整 TTL 值
- 监控缓存命中率
- 定期清理过期缓存
- 使用连接池优化数据库性能

**章节来源**
- [backend/tests/manual_scripts/test_redis_cache.py](file://backend/tests/manual_scripts/test_redis_cache.py#L355-L357)
- [backend/app/core/config.py](file://backend/app/core/config.py#L28-L29)

## 故障排除指南

### 常见配置问题

#### 数据库连接失败
**症状**：后端启动时报数据库连接错误
**排查步骤**：
1. 检查 .env 中的 SQLALCHEMY_DATABASE_URI 配置
2. 验证数据库服务状态
3. 确认网络连通性

#### DASHSCOPE_API_KEY 错误
**症状**：AI 功能无法正常使用
**解决方法**：
1. 访问 https://dashscope.console.aliyun.com/apiKey 获取 API Key
2. 在 .env 中正确配置 DASHSCOPE_API_KEY
3. 重启后端服务

#### Redis 连接失败
**症状**：缓存功能不可用
**解决方法**：
1. 检查 Redis 服务状态
2. 验证 REDIS_URL 配置
3. 确认防火墙设置

**章节来源**
- [QUICKSTART.md](file://QUICKSTART.md#L194-L235)
- [README.md](file://README.md#L286-L356)

## 结论
本指南详细阐述了 Universal BI 项目的环境变量配置体系，包括应用基础配置、安全配置、数据库连接、AI 模型配置、缓存配置和向量数据库配置。通过 Docker Compose 的配置继承机制，实现了开发和生产环境的一致性管理。建议在生产环境中：
- 使用强随机密钥替换默认 SECRET_KEY
- 配置合适的过期时间
- 设置专用的数据库和缓存实例
- 实施监控和日志记录
- 定期更新和维护配置

## 附录

### 环境变量配置清单

#### 应用配置
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| PROJECT_NAME | 字符串 | "Universal BI" | 应用名称 |
| API_V1_STR | 字符串 | "/api/v1" | API 版本前缀 |

#### 安全配置
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| SECRET_KEY | 字符串 | 随机密钥 | JWT 签名密钥 |
| ALGORITHM | 字符串 | "HS256" | JWT 算法 |
| ACCESS_TOKEN_EXPIRE_MINUTES | 整数 | 30 | 令牌过期时间 |

#### 数据库配置
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| SQLALCHEMY_DATABASE_URI | 字符串 | MySQL 连接 | 数据库连接字符串 |
| VN_PG_HOST | 字符串 | "localhost" | 向量数据库主机 |
| VN_PG_PORT | 整数 | 5432 | 向量数据库端口 |
| VN_PG_DB | 字符串 | "universal_bi_vector" | 向量数据库名 |
| VN_PG_USER | 字符串 | "postgres" | 向量数据库用户 |
| VN_PG_PASSWORD | 字符串 | "postgres" | 向量数据库密码 |

#### AI 配置
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| DASHSCOPE_API_KEY | 字符串 | 空 | DashScope API Key |
| QWEN_MODEL | 字符串 | "qwen-max" | 通义千问模型 |

#### 缓存配置
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| REDIS_URL | 字符串 | "redis://localhost:6379/0" | Redis 连接地址 |
| REDIS_CACHE_TTL | 整数 | 300 | 结果缓存过期时间 |
| SQL_CACHE_TTL | 整数 | 604800 | SQL 缓存过期时间 |

#### Docker 配置
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| MYSQL_PORT | 整数 | 3306 | MySQL 端口 |
| POSTGRES_PORT | 整数 | 5432 | PostgreSQL 端口 |
| REDIS_PORT | 整数 | 6379 | Redis 端口 |
| BACKEND_PORT | 整数 | 8000 | 后端端口 |
| FRONTEND_PORT | 整数 | 3000 | 前端端口 |

### 配置创建流程

#### 步骤 1：复制配置模板
```bash
cp .env.example .env
```

#### 步骤 2：配置必需项
- 设置 DASHSCOPE_API_KEY
- 配置数据库连接信息
- 设置缓存连接信息

#### 步骤 3：调整可选配置
- 修改应用名称和 API 前缀
- 调整 JWT 过期时间
- 配置缓存 TTL 参数

#### 步骤 4：验证配置
```bash
# 检查配置文件
cat .env | grep -E "(DASHSCOPE_API_KEY|SQLALCHEMY_DATABASE_URI|REDIS_URL)"

# 启动服务验证
docker-compose up -d
docker-compose logs -f
```

**章节来源**
- [QUICKSTART.md](file://QUICKSTART.md#L44-L74)
- [README.md](file://README.md#L111-L122)