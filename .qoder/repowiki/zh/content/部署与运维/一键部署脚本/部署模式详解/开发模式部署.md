# 开发模式部署

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [QUICKSTART.md](file://QUICKSTART.md)
- [setup.sh](file://setup.sh)
- [requirements.txt](file://requirements.txt)
- [.env.example](file://.env.example)
- [backend/app/main.py](file://backend/app/main.py)
- [frontend/vite.config.ts](file://frontend/vite.config.ts)
- [backend/app/core/config.py](file://backend/app/core/config.py)
- [backend/init_db.py](file://backend/init_db.py)
- [frontend/src/utils/http/index.ts](file://frontend/src/utils/http/index.ts)
- [frontend/package.json](file://frontend/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [Python虚拟环境与后端依赖](#python虚拟环境与后端依赖)
4. [Node.js环境与前端依赖](#nodejs环境与前端依赖)
5. [运行FastAPI与Vite开发服务器](#运行fastapi与vite开发服务器)
6. [环境变量配置](#环境变量配置)
7. [前后端联调与调试](#前后端联调与调试)
8. [常见问题排查](#常见问题排查)
9. [总结](#总结)

## 简介

本指南旨在为开发者提供在本地环境中进行开发模式部署的详细说明。该模式适用于需要频繁修改代码、调试功能的开发人员。通过本指南，您将学习如何配置Python虚拟环境、安装Node.js依赖、运行后端FastAPI服务和前端Vite开发服务器，并确保两者在不同端口下协同工作。同时，指南还涵盖了环境变量配置、跨域问题处理以及常见问题的解决方案。

**Section sources**
- [README.md](file://README.md#L1-L507)
- [QUICKSTART.md](file://QUICKSTART.md#L1-L274)

## 项目结构

本项目的目录结构清晰，分为后端、前端和文档三大模块：

- `backend/`：包含FastAPI后端代码，包括API端点、数据库模型、服务逻辑等。
- `frontend/`：包含Vue 3 + TypeScript前端代码，使用Vite构建，包含组件、视图、API调用等。
- `docs/`：包含项目相关的文档，如技术栈说明、功能状态等。
- 根目录下包含环境变量模板、Docker配置、依赖文件等。

这种结构有利于前后端分离开发，便于团队协作和维护。

```mermaid
graph TD
A[项目根目录] --> B[backend]
A --> C[frontend]
A --> D[docs]
B --> E[app]
B --> F[migrations]
B --> G[scripts]
B --> H[requirements.txt]
C --> I[src]
C --> J[public]
C --> K[vite.config.ts]
C --> L[package.json]
```

**Diagram sources**
- [README.md](file://README.md#L375-L421)

## Python虚拟环境与后端依赖

开发模式下，后端使用Python 3.8+和FastAPI框架。为避免依赖冲突，建议使用Python虚拟环境。

### 创建虚拟环境并安装依赖

1. 进入后端目录：
   ```bash
   cd backend
   ```

2. 创建Python虚拟环境：
   ```bash
   python3 -m venv venv
   ```

3. 激活虚拟环境：
   ```bash
   source venv/bin/activate  # Linux/macOS
   # 或
   venv\Scripts\activate     # Windows
   ```

4. 安装后端依赖：
   ```bash
   pip install -r requirements.txt
   ```

`requirements.txt`文件中列出了所有必需的Python包，包括`fastapi`、`uvicorn`、`sqlalchemy`、`vanna`、`chromadb`等。

### 初始化数据库

安装依赖后，需初始化数据库并创建默认管理员账户：

```bash
python init_db.py
```

该脚本会创建所有数据表，并插入一个默认管理员账户（用户名：`admin`，密码：`admin123`）。

**Section sources**
- [requirements.txt](file://requirements.txt#L1-L15)
- [backend/init_db.py](file://backend/init_db.py#L1-L79)
- [setup.sh](file://setup.sh#L182-L189)

## Node.js环境与前端依赖

前端使用Vue 3 + TypeScript开发，构建工具为Vite。

### 安装Node.js依赖

1. 进入前端目录：
   ```bash
   cd frontend
   ```

2. 使用npm或pnpm安装依赖：
   ```bash
   npm install
   # 或
   pnpm install
   ```

`package.json`文件中定义了所有前端依赖，包括`vue`、`element-plus`、`tailwindcss`、`echarts`等。

### 依赖管理脚本

项目提供了一键部署脚本`setup.sh`，可自动检测环境并安装前后端依赖。执行以下命令可快速配置开发环境：

```bash
bash setup.sh dev
```

该脚本会自动检查并安装Python、Node.js，配置环境变量，并安装所有依赖。

**Section sources**
- [frontend/package.json](file://frontend/package.json#L1-L40)
- [setup.sh](file://setup.sh#L193-L197)

## 运行FastAPI与Vite开发服务器

开发模式下，后端使用Uvicorn运行FastAPI应用，前端使用Vite启动开发服务器。

### 启动后端服务

在后端目录下，使用以下命令启动FastAPI服务：

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

- `--reload`：启用热重载，代码修改后自动重启。
- `--host 0.0.0.0`：允许外部访问。
- `--port 8000`：指定端口为8000。

后端服务将运行在 `http://localhost:8000`，API文档可通过 `http://localhost:8000/docs` 访问。

### 启动前端开发服务器

在前端目录下，启动Vite开发服务器：

```bash
npm run dev
```

前端服务将运行在 `http://localhost:3000`。

### 配置端口与代理

前端`vite.config.ts`中配置了代理，将`/api`请求转发到后端服务，解决跨域问题：

```typescript
server: {
  port: 3000,
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true
    }
  }
}
```

这样，前端发起的`/api/v1/xxx`请求会被代理到`http://127.0.0.1:8000/api/v1/xxx`。

**Section sources**
- [backend/app/main.py](file://backend/app/main.py#L1-L35)
- [frontend/vite.config.ts](file://frontend/vite.config.ts#L1-L27)
- [README.md](file://README.md#L140-L142)
- [QUICKSTART.md](file://QUICKSTART.md#L158-L159)

## 环境变量配置

项目使用`.env`文件管理环境变量。首次部署时，需复制模板文件并配置关键参数。

### 配置步骤

1. 复制环境变量模板：
   ```bash
   cp .env.example .env
   ```

2. 编辑`.env`文件，至少配置以下项：
   ```env
   # 通义千问 API Key（必填）
   DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxx

   # 数据库连接
   SQLALCHEMY_DATABASE_URI=mysql+pymysql://root:password@localhost:3306/universal_bi?charset=utf8mb4

   # Redis 缓存
   REDIS_URL=redis://localhost:6379/0
   ```

### 关键配置项说明

- `DASHSCOPE_API_KEY`：用于调用阿里云通义千问大模型，是AI生成SQL的关键。
- `SQLALCHEMY_DATABASE_URI`：配置主数据库连接，支持MySQL、PostgreSQL、SQLite。
- `REDIS_URL`：配置Redis缓存服务，用于缓存查询结果。
- `BACKEND_PORT` 和 `FRONTEND_PORT`：分别定义后端和前端服务端口。

这些配置在`backend/app/core/config.py`中通过`pydantic-settings`加载，确保配置统一管理。

**Section sources**
- [.env.example](file://.env.example#L1-L72)
- [backend/app/core/config.py](file://backend/app/core/config.py#L1-L51)

## 前后端联调与调试

开发模式下，前后端分离运行，需确保两者能正常通信。

### 联调流程

1. 启动后端服务（端口8000）。
2. 启动前端服务（端口3000）。
3. 访问 `http://localhost:3000`，前端页面加载。
4. 前端通过代理向 `http://localhost:8000/api/v1/xxx` 发起请求。
5. 后端返回数据，前端渲染页面。

### 调试工具

- **后端调试**：使用`uvicorn`的`--reload`参数，代码修改后自动重启。
- **前端调试**：使用浏览器开发者工具，查看网络请求、控制台日志。
- **API调试**：访问 `http://localhost:8000/docs`，使用Swagger UI测试API。

### 跨域问题处理

后端`app/main.py`中已配置CORS中间件，允许所有来源的请求：

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

同时，前端Vite配置了代理，双重保障解决跨域问题。

**Section sources**
- [backend/app/main.py](file://backend/app/main.py#L16-L23)
- [frontend/src/utils/http/index.ts](file://frontend/src/utils/http/index.ts#L1-L173)

## 常见问题排查

### 端口冲突

**问题**：端口8000或3000已被占用。

**解决方法**：
- 修改`vite.config.ts`中的`server.port`。
- 修改启动命令中的`--port`参数。
- 使用`lsof -i :8000`（macOS/Linux）或`netstat -ano | findstr :8000`（Windows）查找并终止占用进程。

### 跨域问题（CORS）

**问题**：浏览器报CORS错误。

**解决方法**：
- 确认后端已启用CORS中间件。
- 确认前端Vite代理配置正确。
- 检查请求路径是否以`/api`开头，确保被代理。

### 依赖版本不兼容

**问题**：安装依赖后运行报错。

**解决方法**：
- 确保Python版本为3.8+，Node.js版本为16+。
- 删除`node_modules`和`package-lock.json`，重新运行`npm install`。
- 在虚拟环境中重新安装Python依赖。

### 数据库连接失败

**问题**：后端启动时无法连接数据库。

**解决方法**：
- 检查`.env`文件中的`SQLALCHEMY_DATABASE_URI`配置。
- 确认数据库服务已启动。
- 使用`mysql -h localhost -u root -p`测试数据库连接。

### Redis连接问题

**问题**：Redis服务未启动或配置错误。

**解决方法**：
- 启动Redis服务：`redis-server`。
- 检查`.env`文件中的`REDIS_URL`配置。
- 使用`redis-cli ping`测试连接。

**Section sources**
- [README.md](file://README.md#L284-L356)
- [QUICKSTART.md](file://QUICKSTART.md#L193-L250)

## 总结

开发模式部署为开发者提供了灵活、高效的本地开发环境。通过Python虚拟环境和Node.js依赖管理，确保了依赖的隔离与一致性。FastAPI与Vite的组合提供了现代化的全栈开发体验，而端口分离与代理配置则解决了前后端联调的常见问题。环境变量的集中管理使得配置更加安全与便捷。对于需要频繁修改代码、调试功能的开发者，此模式是理想的选择。