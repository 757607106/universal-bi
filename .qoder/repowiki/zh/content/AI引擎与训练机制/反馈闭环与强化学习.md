# åé¦ˆé—­ç¯ä¸å¼ºåŒ–å­¦ä¹ 

<cite>
**æœ¬æ–‡å¼•ç”¨çš„æ–‡ä»¶**
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md)
- [CHANGELOG_FEEDBACK.md](file://docs/backend/CHANGELOG_FEEDBACK.md)
- [train_qa_fix.py](file://backend/scripts/train_qa_fix.py)
- [test_feedback_rlhf.py](file://backend/tests/test_feedback_rlhf.py)
- [chat.py](file://backend/app/api/v1/endpoints/chat.py)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py)
- [chat.pyï¼ˆschemaï¼‰](file://backend/app/schemas/chat.py)
- [index.vue](file://frontend/src/views/Chat/index.vue)
- [FEEDBACK_USER_GUIDE.md](file://docs/frontend/FEEDBACK_USER_GUIDE.md)
- [metadata.py](file://backend/app/models/metadata.py)
- [deps.py](file://backend/app/api/deps.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹
æœ¬æ–‡ä»¶ç³»ç»ŸåŒ–é˜è¿° ChatBI çš„ç”¨æˆ·åé¦ˆé©±åŠ¨å¼ºåŒ–å­¦ä¹ æœºåˆ¶ï¼ˆRLHFï¼‰ã€‚è¯¥æœºåˆ¶é€šè¿‡â€œç‚¹èµ/ç‚¹è¸©â€äº¤äº’ï¼Œå°†ç”¨æˆ·ä¿®æ­£ SQL çš„è¡Œä¸ºè½¬åŒ–ä¸ºé«˜è´¨é‡è®­ç»ƒæ ·æœ¬ï¼Œæ³¨å…¥å‘é‡åº“ï¼ˆChromaDBï¼‰ä»¥æå‡ SQL ç”Ÿæˆå‡†ç¡®ç‡ã€‚æ–‡æ¡£è¦†ç›–åé¦ˆæ•°æ®çš„é‡‡é›†ã€æ¸…æ´—ä¸å»é‡ç­–ç•¥ã€è®­ç»ƒæ³¨å…¥æµç¨‹ã€ç¼“å­˜æ¸…ç†ä¸ç”Ÿæ•ˆæœºåˆ¶ã€æƒé™æ§åˆ¶ã€ç‰ˆæœ¬å›æº¯ä¸å†å²è¿½è¸ªã€ä»¥åŠä¼ä¸šçº§å®¡æ‰¹æµç¨‹é›†æˆå»ºè®®ã€‚åŒæ—¶ç»™å‡ºé€šè¿‡ API è§¦å‘æ¨¡å‹å†è®­ç»ƒä¸è¯„ä¼°æ–°æ¨¡å‹æ€§èƒ½çš„æ–¹æ³•ã€‚

## é¡¹ç›®ç»“æ„
å›´ç»• RLHF çš„å…³é”®ç›®å½•ä¸æ–‡ä»¶å¦‚ä¸‹ï¼š
- åç«¯ APIï¼š/backend/app/api/v1/endpoints/chat.py
- è®­ç»ƒæœåŠ¡ï¼š/backend/app/services/vanna_manager.py
- å‰ç«¯äº¤äº’ï¼š/frontend/src/views/Chat/index.vue
- åé¦ˆè„šæœ¬ï¼š/backend/scripts/train_qa_fix.py
- æµ‹è¯•è„šæœ¬ï¼š/backend/tests/test_feedback_rlhf.py
- æ–‡æ¡£ï¼šdocs/backend/FEEDBACK_RLHF.mdã€docs/backend/CHANGELOG_FEEDBACK.mdã€docs/frontend/FEEDBACK_USER_GUIDE.md
- æ•°æ®æ¨¡å‹ï¼šbackend/app/models/metadata.py
- ä¾èµ–ä¸æƒé™ï¼šbackend/app/api/deps.py
- Schema å®šä¹‰ï¼šbackend/app/schemas/chat.py

```mermaid
graph TB
subgraph "å‰ç«¯"
FE["Chat/index.vue<br/>åé¦ˆæŒ‰é’®ä¸ä¿®æ­£å¯¹è¯æ¡†"]
end
subgraph "åç«¯"
API["chat.py<br/>/api/v1/chat/feedback"]
SVC["vanna_manager.py<br/>VannaManager.train_qa()"]
DBM["metadata.py<br/>Dataset/TrainingLog"]
DEPS["deps.py<br/>apply_ownership_filter()"]
end
subgraph "å¤–éƒ¨ç³»ç»Ÿ"
VDB["ChromaDB Vector Store"]
REDIS["Redis ç¼“å­˜"]
end
FE --> API
API --> DEPS
API --> SVC
SVC --> VDB
SVC --> REDIS
API --> DBM
```

å›¾ç¤ºæ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L44-L112)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)
- [metadata.py](file://backend/app/models/metadata.py#L35-L80)
- [deps.py](file://backend/app/api/deps.py#L97-L124)
- [index.vue](file://frontend/src/views/Chat/index.vue#L238-L265)

ç« èŠ‚æ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L1-L156)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)
- [index.vue](file://frontend/src/views/Chat/index.vue#L1-L800)

## æ ¸å¿ƒç»„ä»¶
- åé¦ˆ APIï¼šæ¥æ”¶ rating=1ï¼ˆç‚¹èµï¼‰æˆ– rating=-1ï¼ˆç‚¹è¸©ï¼‰çš„åé¦ˆï¼Œè°ƒç”¨è®­ç»ƒæœåŠ¡æ³¨å…¥å‘é‡åº“ï¼Œå¹¶æ¸…ç†ç¼“å­˜ã€‚
- è®­ç»ƒæœåŠ¡ï¼šå°è£… Vanna è®­ç»ƒå…¥å£ï¼Œç»Ÿä¸€è®­ç»ƒé—®ç­”å¯¹ã€æœ¯è¯­ã€æ–‡æ¡£ä¸ DDLï¼Œå¹¶æä¾›ç¼“å­˜æ¸…ç†ä¸é›†åˆåˆ é™¤èƒ½åŠ›ã€‚
- å‰ç«¯äº¤äº’ï¼šæä¾›ç‚¹èµ/ç‚¹è¸©æŒ‰é’®ä¸ SQL ä¿®æ­£å¯¹è¯æ¡†ï¼Œé˜²é‡å¤æäº¤ï¼Œæ ‡è®°åé¦ˆçŠ¶æ€ã€‚
- æƒé™ä¸æ•°æ®éš”ç¦»ï¼šåŸºäº owner_id çš„è®¿é—®æ§åˆ¶ï¼Œå…¬å…±èµ„æºä»…è¶…çº§ç®¡ç†å‘˜å¯è®­ç»ƒã€‚
- è®­ç»ƒæ•°æ®å­˜å‚¨ï¼šChromaDB å‘é‡åº“ï¼Œé”®ç©ºé—´åŒ…å«è®­ç»ƒè®¡åˆ’é›†åˆä¸æ–‡æ¡£å…ƒæ•°æ®ã€‚
- ç¼“å­˜æ¸…ç†ï¼šè®­ç»ƒåæ¸…ç† Redis ç¼“å­˜ï¼Œç¡®ä¿æ–°çŸ¥è¯†ç«‹å³ç”Ÿæ•ˆã€‚

ç« èŠ‚æ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L44-L112)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)
- [index.vue](file://frontend/src/views/Chat/index.vue#L238-L265)
- [deps.py](file://backend/app/api/deps.py#L97-L124)

## æ¶æ„æ€»è§ˆ
åé¦ˆé—­ç¯çš„å…³é”®æµç¨‹ï¼š
1. ç”¨æˆ·åœ¨å‰ç«¯ç‚¹å‡»â€œç‚¹èµ/ç‚¹è¸©â€ï¼Œè‹¥ç‚¹è¸©åˆ™å¼¹å‡º SQL ä¿®æ­£å¯¹è¯æ¡†ã€‚
2. å‰ç«¯è°ƒç”¨åç«¯ /api/v1/chat/feedback æ¥å£ï¼Œæºå¸¦ dataset_idã€questionã€sqlã€ratingã€‚
3. åç«¯è¿›è¡Œæ•°æ®é›†è®¿é—®æƒé™æ ¡éªŒä¸å…¬å…±èµ„æºè®­ç»ƒé™åˆ¶ã€‚
4. è°ƒç”¨ VannaManager.train_qaï¼Œä½¿ç”¨ Legacy API å°†é—®ç­”å¯¹å†™å…¥ ChromaDBã€‚
5. è‡ªåŠ¨æ¸…ç† Redis ç¼“å­˜ï¼Œç¡®ä¿æ–°è®­ç»ƒç«‹å³ç”Ÿæ•ˆã€‚
6. è¿”å›æˆåŠŸæç¤ºï¼Œå‰ç«¯æ ‡è®°æŒ‰é’®çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤æäº¤ã€‚

```mermaid
sequenceDiagram
participant U as "ç”¨æˆ·"
participant FE as "å‰ç«¯ Chat/index.vue"
participant API as "åç«¯ chat.py"
participant SVC as "VannaManager"
participant VDB as "ChromaDB"
participant RC as "Redis ç¼“å­˜"
U->>FE : ç‚¹å‡» ğŸ‘ æˆ– ğŸ‘
alt ç‚¹è¸©
FE->>FE : æ‰“å¼€ SQL ä¿®æ­£å¯¹è¯æ¡†
FE->>API : POST /api/v1/chat/feedback
else ç‚¹èµ
FE->>API : POST /api/v1/chat/feedback
end
API->>API : apply_ownership_filter() æ ¡éªŒæƒé™
API->>SVC : train_qa(dataset_id, question, sql)
SVC->>VDB : train(question, sql)
SVC->>RC : clear_cache(dataset_id)
API-->>FE : è¿”å› success/message
FE-->>U : æŒ‰é’®ç¦ç”¨/çŠ¶æ€æ ‡è®°
```

å›¾ç¤ºæ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L44-L112)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L174-L220)
- [index.vue](file://frontend/src/views/Chat/index.vue#L238-L265)

ç« èŠ‚æ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L44-L112)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L174-L220)
- [index.vue](file://frontend/src/views/Chat/index.vue#L238-L265)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### åç«¯ APIï¼šåé¦ˆæ¥å£
- æ¥å£è·¯å¾„ï¼š/api/v1/chat/feedback
- è¯·æ±‚ä½“ï¼šdataset_idã€questionã€sqlã€ratingï¼ˆ1 æˆ– -1ï¼‰
- æƒé™æ§åˆ¶ï¼šé€šè¿‡ apply_ownership_filter æ ¡éªŒæ•°æ®é›†è®¿é—®æƒé™ï¼›å…¬å…±èµ„æºä»…è¶…çº§ç®¡ç†å‘˜å¯è®­ç»ƒã€‚
- é€»è¾‘åˆ†æ”¯ï¼š
  - rating=1ï¼šè®­ç»ƒåŸå§‹ SQL
  - rating=-1ï¼šè®­ç»ƒç”¨æˆ·æä¾›çš„ä¿®æ­£ SQL
- å“åº”ï¼šsuccess ä¸ message

```mermaid
flowchart TD
Start(["è¿›å…¥ /api/v1/chat/feedback"]) --> CheckDS["æŸ¥è¯¢æ•°æ®é›†å¹¶åº”ç”¨è®¿é—®æ§åˆ¶"]
CheckDS --> DSFound{"æ•°æ®é›†å­˜åœ¨ä¸”å¯è®¿é—®ï¼Ÿ"}
DSFound --> |å¦| Err404["è¿”å› 404/403"]
DSFound --> |æ˜¯| Rating{"rating=1 è¿˜æ˜¯ -1ï¼Ÿ"}
Rating --> |1| TrainOrig["train_qa(dataset_id, question, sql=åŸå§‹SQL)"]
Rating --> |-1| TrainCorr["train_qa(dataset_id, question, sql=ä¿®æ­£SQL)"]
TrainOrig --> Clear["clear_cache(dataset_id)"]
TrainCorr --> Clear
Clear --> Resp["è¿”å› success/message"]
```

å›¾ç¤ºæ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L44-L112)
- [deps.py](file://backend/app/api/deps.py#L97-L124)

ç« èŠ‚æ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L44-L112)
- [deps.py](file://backend/app/api/deps.py#L97-L124)

### è®­ç»ƒæœåŠ¡ï¼šVannaManager.train_qa
- åŠŸèƒ½ï¼šä½¿ç”¨ Legacy Vanna API è®­ç»ƒé—®ç­”å¯¹ï¼Œå†™å…¥ ChromaDB å‘é‡åº“ã€‚
- æ•ˆæœï¼šé—®ç­”å¯¹ç«‹å³å…¥åº“ï¼Œéšåæ¸…ç† Redis ç¼“å­˜ï¼Œç¡®ä¿æ–°çŸ¥è¯†ç”Ÿæ•ˆã€‚
- å…³é”®å®ç°ç‚¹ï¼š
  - get_legacy_vanna(collection_name)ï¼šæŒ‰æ•°æ®é›†æ„å»ºå‘é‡åº“é›†åˆåå¹¶å¤ç”¨å®ä¾‹ã€‚
  - clear_cache(dataset_id)ï¼šæ¸…ç† bi:cache ä¸ bi:sql_cache å‰ç¼€é”®ã€‚
  - è®­ç»ƒåæ¸…ç†ç¼“å­˜ï¼Œé¿å…æ—§ç¼“å­˜è¦†ç›–æ–°çŸ¥è¯†ã€‚

```mermaid
classDiagram
class VannaManager {
+train_qa(dataset_id, question, sql, db_session)
+get_legacy_vanna(dataset_id)
+clear_cache(dataset_id)
}
class VannaLegacy {
+train(question, sql)
}
VannaManager --> VannaLegacy : "ä½¿ç”¨ Legacy API è®­ç»ƒ"
```

å›¾ç¤ºæ¥æº
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)

ç« èŠ‚æ¥æº
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)

### å‰ç«¯äº¤äº’ï¼šåé¦ˆæŒ‰é’®ä¸ä¿®æ­£å¯¹è¯æ¡†
- UI ä½ç½®ï¼šChat/index.vue çš„æ¶ˆæ¯æ°”æ³¡åº•éƒ¨ã€‚
- äº¤äº’é€»è¾‘ï¼š
  - ç‚¹èµï¼šæäº¤ rating=1ï¼Œæ ‡è®°æŒ‰é’®ä¸ºå·²åé¦ˆï¼Œç¦ç”¨ã€‚
  - ç‚¹è¸©ï¼šæ‰“å¼€ SQL ä¿®æ­£å¯¹è¯æ¡†ï¼Œé¢„å¡«å½“å‰ SQLï¼Œæäº¤ rating=-1 ä¸ä¿®æ­£ SQLã€‚
  - é˜²é‡å¤ï¼šfeedbackGiven å­—æ®µæ§åˆ¶æŒ‰é’®ç¦ç”¨çŠ¶æ€ã€‚
- ä¿®æ­£å¯¹è¯æ¡†ï¼šæä¾› textarea è¾“å…¥ä¸æäº¤æŒ‰é’®ï¼Œæç¤ºâ€œAI ä¼šå­¦ä¹ ä½ æä¾›çš„æ­£ç¡® SQLâ€ã€‚

```mermaid
flowchart TD
Click["ç‚¹å‡» ğŸ‘ æˆ– ğŸ‘"] --> Like{"rating==1ï¼Ÿ"}
Like --> |æ˜¯| SubmitLike["æäº¤ rating=1 + åŸå§‹ SQL"]
Like --> |å¦| OpenDlg["æ‰“å¼€ SQL ä¿®æ­£å¯¹è¯æ¡†"]
OpenDlg --> Edit["ç¼–è¾‘ä¿®æ­£ SQL"]
Edit --> SubmitDislike["æäº¤ rating=-1 + ä¿®æ­£ SQL"]
SubmitLike --> Mark["æ ‡è®°æŒ‰é’®çŠ¶æ€å¹¶ç¦ç”¨"]
SubmitDislike --> Mark
```

å›¾ç¤ºæ¥æº
- [index.vue](file://frontend/src/views/Chat/index.vue#L238-L265)

ç« èŠ‚æ¥æº
- [index.vue](file://frontend/src/views/Chat/index.vue#L238-L265)

### è®­ç»ƒæ•°æ®å­˜å‚¨ä¸è¯­ä¹‰æ£€ç´¢
- ChromaDB é›†åˆå‘½åï¼štraining-plan-{dataset_id} æˆ– vec_ds_{dataset_id}
- æ–‡æ¡£ç»“æ„ï¼šåŒ…å« idã€questionã€contentï¼ˆSQLï¼‰ã€training_data_type ç­‰å…ƒæ•°æ®ã€‚
- è¯­ä¹‰æ£€ç´¢ï¼šå‘é‡åº“ä¸­ Top-K ç›¸ä¼¼é—®é¢˜ä¼˜å…ˆå‚è€ƒï¼Œç»“åˆ DDL/æ–‡æ¡£ç”Ÿæˆæœ€ç»ˆ SQLã€‚

ç« èŠ‚æ¥æº
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L366-L387)

### ç¼“å­˜æ¸…ç†ç­–ç•¥
- æ¸…ç†æ—¶æœºï¼šè®­ç»ƒåç«‹å³æ¸…ç†ï¼Œé¿å…ç¼“å­˜å‘½ä¸­å¯¼è‡´æ–°çŸ¥è¯†ä¸ç”Ÿæ•ˆã€‚
- æ¸…ç†é”®å‰ç¼€ï¼šbi:cache:{dataset_id}:* ä¸ bi:sql_cache:{dataset_id}:*
- æ¸…ç†å®ç°ï¼šé€šè¿‡ Redis keys åŒ¹é…ä¸ delete æ‰¹é‡åˆ é™¤ã€‚

ç« èŠ‚æ¥æº
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L174-L220)
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L389-L408)

### åé¦ˆæ•°æ®æ¸…æ´—ã€éªŒè¯ä¸å»é‡
- æ¸…æ´—ä¸éªŒè¯ï¼ˆå»ºè®®å®ç°ï¼‰ï¼š
  - SQL è¯­æ³•æ ¡éªŒï¼šé€šè¿‡è§£æå™¨æˆ–æœ€å°æ‰§è¡Œå°è¯•ï¼Œæ‹’ç»è¯­æ³•é”™è¯¯çš„ SQLã€‚
  - ä¸šåŠ¡ä¸€è‡´æ€§ï¼šä¸æ•°æ®å­—å…¸ã€ä¸šåŠ¡æœ¯è¯­å¯¹é½ï¼Œé¿å…é€»è¾‘ä¸ç¬¦ã€‚
  - æ€§èƒ½é˜ˆå€¼ï¼šæ’é™¤æ˜æ˜¾ä½æ•ˆæˆ–å†—ä½™çš„ SQLã€‚
- å»é‡ç­–ç•¥ï¼ˆå»ºè®®å®ç°ï¼‰ï¼š
  - åŸºäºé—®é¢˜å“ˆå¸Œä¸ SQL å“ˆå¸Œçš„è”åˆå»é‡ã€‚
  - æ—¶é—´çª—å£å†…ï¼ˆå¦‚ 1 å°æ—¶ï¼‰ç›¸åŒé—®é¢˜çš„é‡å¤ä¿®æ­£åˆå¹¶ä¸ºä¸€æ¬¡è®­ç»ƒã€‚
  - è¯­ä¹‰è¿‘ä¼¼æ£€æµ‹ï¼šä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤é«˜åº¦ç›¸ä¼¼çš„é—®ç­”å¯¹ã€‚
- æ³¨å…¥è®­ç»ƒï¼šé€šè¿‡ Legacy API çš„ train(question, sql) å†™å…¥å‘é‡åº“ã€‚

ç« èŠ‚æ¥æº
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L352-L363)

### åé¦ˆç§¯åˆ†æœºåˆ¶ä¸æ•°æ®æƒé‡åˆ†é…
- æƒé‡å»ºè®®ï¼ˆæ¦‚å¿µæ€§è®¾è®¡ï¼‰ï¼š
  - åŸºç¡€æƒé‡ï¼šç‚¹èµ +1ï¼Œç‚¹è¸©ä¿®æ­£ +2ï¼ˆä¿®æ­£æ›´å®è´µï¼‰ã€‚
  - æ—¶é—´è¡°å‡ï¼šè¿‘æœŸåé¦ˆæƒé‡æ›´é«˜ï¼ˆä¾‹å¦‚æŒ‰å¤©æŒ‡æ•°è¡°å‡ï¼‰ã€‚
  - ä¸“å®¶æƒé‡ï¼šè¶…çº§ç®¡ç†å‘˜æˆ–ç‰¹å®šè§’è‰²çš„åé¦ˆæƒé‡å€å¢ã€‚
  - ä¸šåŠ¡é‡è¦æ€§ï¼šæ ¸å¿ƒä¸šåŠ¡åœºæ™¯æƒé‡æ›´é«˜ã€‚
- åˆ†é…ç­–ç•¥ï¼š
  - å‘é‡åº“ä¸­ä¸ºæ¯ä¸ªé—®ç­”å¯¹è®¾ç½® metadata.weightã€‚
  - æ£€ç´¢æ—¶æŒ‰æƒé‡åŠ æƒæ’åºï¼ŒTop-K é€‰æ‹©æ—¶ä¼˜å…ˆé«˜æƒé‡æ ·æœ¬ã€‚
  - è®­ç»ƒæ—¶å¯å°†é«˜æƒé‡æ ·æœ¬é‡å¤å†™å…¥æˆ–å¢å¼ºé‡‡æ ·é¢‘ç‡ã€‚

ç« èŠ‚æ¥æº
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L352-L363)

### ç‰ˆæœ¬å›æº¯ä¸å†å²è¿½è¸ª
- å†å²è¿½è¸ªï¼ˆå»ºè®®å®ç°ï¼‰ï¼š
  - è®­ç»ƒæ—¥å¿—è¡¨ï¼šè®°å½•æ¯æ¬¡è®­ç»ƒçš„ questionã€sqlã€æ—¶é—´æˆ³ã€æƒé‡ã€æ¥æºï¼ˆç”¨æˆ·/è„šæœ¬ï¼‰ã€‚
  - è®­ç»ƒæ‰¹æ¬¡ï¼šæŒ‰æ—¥æœŸ/æ‰¹æ¬¡å·å½’æ¡£ï¼Œæ”¯æŒå¯¼å‡ºä¸å›æ»šã€‚
  - å˜æ›´è®°å½•ï¼šè®°å½•é›†åˆåˆ é™¤ã€ç¼“å­˜æ¸…ç†ã€æ¨¡å‹åˆ‡æ¢ç­‰å…³é”®äº‹ä»¶ã€‚
- å›æº¯èƒ½åŠ›ï¼ˆå»ºè®®å®ç°ï¼‰ï¼š
  - è®­ç»ƒå›æ»šï¼šåˆ é™¤æŒ‡å®šæ‰¹æ¬¡çš„å‘é‡è®°å½•å¹¶æ¢å¤æ—§ç¼“å­˜ã€‚
  - A/B å¯¹æ¯”ï¼šä¿ç•™ä¸¤å¥—å‘é‡åº“ï¼Œå¯¹æ¯”ä¸åŒæ‰¹æ¬¡çš„å‡†ç¡®ç‡ã€‚
- CHANGELOG ä½“ç°ï¼š
  - åé¦ˆæœºåˆ¶å®Œå–„ã€æ–‡æ¡£ä¸æµ‹è¯•è„šæœ¬æ–°å¢ã€åŠŸèƒ½çŠ¶æ€æ›´æ–°ç­‰ã€‚

ç« èŠ‚æ¥æº
- [CHANGELOG_FEEDBACK.md](file://docs/backend/CHANGELOG_FEEDBACK.md#L1-L306)
- [metadata.py](file://backend/app/models/metadata.py#L70-L80)

### ä¼ä¸šçº§å®¡æ‰¹æµç¨‹é›†æˆå»ºè®®
- å®¡æ‰¹èŠ‚ç‚¹ï¼ˆå»ºè®®å®ç°ï¼‰ï¼š
  - ç‚¹è¸©ä¿®æ­£éœ€å®¡æ‰¹ï¼šè¶…é˜ˆå€¼æˆ–è·¨éƒ¨é—¨ä¿®æ­£éœ€å®¡æ‰¹äººç¡®è®¤ã€‚
  - æƒé™çŸ©é˜µï¼šæ™®é€šç”¨æˆ·ä»…èƒ½ç‚¹èµï¼›ç‚¹è¸©ä¿®æ­£éœ€å…·å¤‡ç›¸åº”æ•°æ®é›†æƒé™ã€‚
  - å®¡æ‰¹æµï¼šæäº¤ â†’ è‡ªåŠ¨æ ¡éªŒ â†’ å®¡æ‰¹äºº â†’ å®¡æ‰¹é€šè¿‡/é©³å› â†’ è®­ç»ƒæˆ–é€€å›ã€‚
- å®¡æ‰¹è®°å½•ï¼š
  - å®¡æ‰¹æ—¥å¿—ï¼šè®°å½•å®¡æ‰¹äººã€æ—¶é—´ã€æ„è§ã€æœ€ç»ˆå†³ç­–ã€‚
  - å®¡æ‰¹å›æº¯ï¼šæ”¯æŒæŸ¥çœ‹å†å²å®¡æ‰¹ä¸å†³ç­–ä¾æ®ã€‚
- ä¸ CI/CD é›†æˆï¼š
  - å®¡æ‰¹é€šè¿‡åè§¦å‘è®­ç»ƒè„šæœ¬æˆ– APIï¼Œè‡ªåŠ¨æ³¨å…¥å‘é‡åº“ã€‚
  - å¤±è´¥å›æ»šï¼šå®¡æ‰¹é©³å›æ—¶å›é€€åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚

ç« èŠ‚æ¥æº
- [deps.py](file://backend/app/api/deps.py#L97-L124)
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L305-L315)

### é€šè¿‡ API è§¦å‘æ¨¡å‹å†è®­ç»ƒä¸è¯„ä¼°
- è§¦å‘è®­ç»ƒï¼š
  - ä½¿ç”¨ /api/v1/chat/feedback æäº¤ rating=1 æˆ– rating=-1 çš„åé¦ˆã€‚
  - åç«¯è°ƒç”¨ VannaManager.train_qaï¼Œå†™å…¥å‘é‡åº“å¹¶æ¸…ç†ç¼“å­˜ã€‚
- è¯„ä¼°æ–°æ¨¡å‹æ€§èƒ½ï¼š
  - åŸºå‡†æµ‹è¯•ï¼šå‡†å¤‡ä¸€ç»„å›ºå®šé—®é¢˜ä¸æœŸæœ› SQLï¼Œè®¡ç®—å‡†ç¡®ç‡ã€å¬å›ç‡ã€F1ã€‚
  - A/B å¯¹æ¯”ï¼šå¯¹æ¯”è®­ç»ƒå‰åç›¸åŒé—®é¢˜çš„ SQL ç”Ÿæˆä¸€è‡´æ€§ã€‚
  - äººå·¥è¯„ä¼°ï¼šæŠ½æ ·è¯„ä¼° SQL æ­£ç¡®æ€§ã€å¯è¯»æ€§ã€æ€§èƒ½ã€‚
  - æŒ‡æ ‡ç›‘æ§ï¼šè®°å½•ç‚¹èµç‡ã€ç‚¹è¸©ç‡ã€è®­ç»ƒåå‡†ç¡®ç‡æå‡ã€‚

ç« èŠ‚æ¥æº
- [test_feedback_rlhf.py](file://backend/tests/test_feedback_rlhf.py#L134-L181)
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L455-L472)

## ä¾èµ–å…³ç³»åˆ†æ
- å‰ç«¯ä¾èµ–åç«¯ API æä¾›åé¦ˆæ¥å£ä¸èŠå¤©ç»“æœã€‚
- åç«¯ä¾èµ– VannaManager æä¾›è®­ç»ƒä¸ç¼“å­˜æ¸…ç†èƒ½åŠ›ã€‚
- VannaManager ä¾èµ– ChromaDB ä¸ Redisã€‚
- æƒé™æ§åˆ¶ä¾èµ– apply_ownership_filter ä¸ç”¨æˆ·è§’è‰²ã€‚

```mermaid
graph LR
FE["Chat/index.vue"] --> API["chat.py"]
API --> DEPS["deps.py"]
API --> SVC["vanna_manager.py"]
SVC --> VDB["ChromaDB"]
SVC --> RC["Redis"]
API --> DBM["metadata.py"]
```

å›¾ç¤ºæ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L1-L156)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)
- [deps.py](file://backend/app/api/deps.py#L97-L124)
- [metadata.py](file://backend/app/models/metadata.py#L35-L80)

ç« èŠ‚æ¥æº
- [chat.py](file://backend/app/api/v1/endpoints/chat.py#L1-L156)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L101-L270)
- [deps.py](file://backend/app/api/deps.py#L97-L124)

## æ€§èƒ½è€ƒé‡
- ç¼“å­˜æ¸…ç†ï¼šè®­ç»ƒåç«‹å³æ¸…ç†ï¼Œé¿å…ç¼“å­˜å‘½ä¸­å¯¼è‡´æ–°çŸ¥è¯†å»¶è¿Ÿç”Ÿæ•ˆã€‚
- å‘é‡æ£€ç´¢ï¼šåˆç†è®¾ç½® n_resultsï¼Œå¹³è¡¡å¬å›ä¸æ€§èƒ½ã€‚
- è®­ç»ƒé¢‘ç‡ï¼šé«˜é¢‘ä¿®æ­£å»ºè®®åˆå¹¶æ‰¹æ¬¡ï¼Œå‡å°‘å‘é‡åº“å†™æ”¾å¤§ã€‚
- Redis è¿æ¥ï¼šå¤ç”¨è¿æ¥æ± ï¼Œé¿å…é¢‘ç¹è¿æ¥/æ–­å¼€ã€‚
- å‰ç«¯æ¸²æŸ“ï¼šæ¶ˆæ¯åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨ï¼Œé¿å…é•¿å¯¹è¯å†…å­˜å‹åŠ›ã€‚

ç« èŠ‚æ¥æº
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L174-L220)
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L389-L408)

## æ•…éšœæ’æŸ¥æŒ‡å—
- åé¦ˆæäº¤å¤±è´¥ï¼š
  - æ£€æŸ¥æ•°æ®é›†è®¿é—®æƒé™ä¸å…¬å…±èµ„æºè®­ç»ƒé™åˆ¶ã€‚
  - å‰ç«¯æ•è·é”™è¯¯å¹¶è¾“å‡ºè¯¦ç»†æç¤ºã€‚
- è®­ç»ƒåæ•ˆæœä¸æ˜æ˜¾ï¼š
  - æ‰‹åŠ¨æ¸…ç† Redis ç¼“å­˜ï¼›å¤šæ¬¡è®­ç»ƒç›¸åŒé—®ç­”å¯¹æå‡æƒé‡ï¼›ä½¿ç”¨æ›´é€šç”¨çš„é—®é¢˜è¡¨è¿°ã€‚
- SQL ä¿®æ­£å¯¹è¯æ¡†ä¸æ˜¾ç¤ºï¼š
  - æ£€æŸ¥æ¶ˆæ¯å¯¹è±¡æ˜¯å¦åŒ…å«å¿…è¦å­—æ®µï¼ˆsql/question/datasetIdï¼‰ï¼›æ·»åŠ è°ƒè¯•æ—¥å¿—å®šä½é—®é¢˜ã€‚

ç« èŠ‚æ¥æº
- [FEEDBACK_RLHF.md](file://docs/backend/FEEDBACK_RLHF.md#L474-L530)
- [test_feedback_rlhf.py](file://backend/tests/test_feedback_rlhf.py#L183-L239)

## ç»“è®º
ChatBI çš„ RLHF æœºåˆ¶é€šè¿‡â€œç‚¹èµ/ç‚¹è¸©â€ä¸ SQL ä¿®æ­£ï¼Œå°†ç”¨æˆ·åé¦ˆè½¬åŒ–ä¸ºé«˜è´¨é‡è®­ç»ƒæ ·æœ¬ï¼Œæ³¨å…¥å‘é‡åº“å¹¶ç«‹å³ç”Ÿæ•ˆã€‚é…åˆæƒé™æ§åˆ¶ã€ç¼“å­˜æ¸…ç†ä¸æ–‡æ¡£åŒ–æµç¨‹ï¼Œç³»ç»Ÿå®ç°äº†é›¶é…ç½®å­¦ä¹ ä¸æŒç»­ä¼˜åŒ–ã€‚å»ºè®®åœ¨ä¼ä¸šç¯å¢ƒä¸­å¼•å…¥å®¡æ‰¹æµç¨‹ã€æƒé‡åˆ†é…ä¸å†å²è¿½è¸ªï¼Œè¿›ä¸€æ­¥æå‡åé¦ˆè´¨é‡ä¸å¯å®¡è®¡æ€§ï¼Œå¹¶é€šè¿‡ API è§¦å‘å†è®­ç»ƒä¸ A/B è¯„ä¼°ï¼Œå½¢æˆé—­ç¯çš„æ¨¡å‹æ²»ç†ä½“ç³»ã€‚

## é™„å½•
- ç”¨æˆ·æŒ‡å—ï¼šdocs/frontend/FEEDBACK_USER_GUIDE.md
- æŠ€æœ¯æ–‡æ¡£ï¼šdocs/backend/FEEDBACK_RLHF.md
- æ›´æ–°æ—¥å¿—ï¼šdocs/backend/CHANGELOG_FEEDBACK.md
- è®­ç»ƒè„šæœ¬ï¼šbackend/scripts/train_qa_fix.py
- æµ‹è¯•è„šæœ¬ï¼šbackend/tests/test_feedback_rlhf.py