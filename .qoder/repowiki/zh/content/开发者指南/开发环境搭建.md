# 开发环境搭建

<cite>
**本文档引用文件**  
- [README.md](file://README.md)
- [QUICKSTART.md](file://QUICKSTART.md)
- [.env.example](file://.env.example)
- [docker-compose.yml](file://docker-compose.yml)
- [setup.sh](file://setup.sh)
- [setup.bat](file://setup.bat)
- [requirements.txt](file://requirements.txt)
- [package.json](file://frontend/package.json)
- [main.py](file://backend/app/main.py)
- [config.py](file://backend/app/core/config.py)
- [Dockerfile.backend](file://Dockerfile.backend)
- [Dockerfile.frontend](file://Dockerfile.frontend)
- [init_db.py](file://backend/init_db.py)
</cite>

## 目录
1. [简介](#简介)
2. [一键部署脚本](#一键部署脚本)
3. [环境变量配置](#环境变量配置)
4. [Docker Compose 部署](#docker-compose-部署)
5. [手动开发环境搭建](#手动开发环境搭建)
6. [服务启动](#服务启动)
7. [常见问题排查](#常见问题排查)
8. [总结](#总结)

## 简介

Universal BI 是一个基于 AI 的智能数据分析平台，允许用户通过自然语言与数据库交互，自动生成 SQL 查询并可视化结果。本指南详细说明如何搭建本地开发环境，包括使用一键脚本或手动方式配置后端（FastAPI）、AI 引擎、前端（Vue）及依赖服务（PostgreSQL、Redis）。

**Section sources**
- [README.md](file://README.md#L1-L507)

## 一键部署脚本

项目提供跨平台的一键部署脚本，支持 Linux/Mac (`setup.sh`) 和 Windows (`setup.bat`)，可自动完成环境检查、依赖安装和配置。

### Linux/Mac 脚本 (setup.sh)

该 Bash 脚本支持两种模式：
- `dev`：开发模式，安装 Python 和 Node.js 依赖
- `docker`：Docker 模式，构建并启动容器化服务

脚本功能包括：
- 检测操作系统并安装必要工具
- 自动安装 Python 3.10 和 Node.js 18
- 创建虚拟环境并安装后端依赖
- 安装前端 npm 依赖
- 生成 `.env` 配置文件
- 创建 `start_dev.sh` 启动脚本

### Windows 脚本 (setup.bat)

Windows 批处理脚本提供相同功能：
- 检查 Python 和 Node.js 是否已安装
- 复制 `.env.example` 为 `.env`
- 创建 Python 虚拟环境并安装依赖
- 安装前端依赖
- 生成 `start_dev.bat` 启动脚本

使用方法：
```bash
# Linux/Mac
bash setup.sh dev        # 开发模式
bash setup.sh docker     # Docker 模式

# Windows
setup.bat dev            # 开发模式
setup.bat docker         # Docker 模式
```

**Section sources**
- [setup.sh](file://setup.sh#L1-L318)
- [setup.bat](file://setup.bat#L1-L213)

## 环境变量配置

所有配置通过 `.env` 文件管理，需基于 `.env.example` 创建。

### 配置文件创建

```bash
cp .env.example .env
```

### 核心配置项

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `DASHSCOPE_API_KEY` | **必填**：通义千问 API 密钥 | `sk-xxxxxxxxxxxxxxxx` |
| `SECRET_KEY` | JWT 签名密钥，生产环境需更换 | `your_secure_random_key` |
| `SQLALCHEMY_DATABASE_URI` | 主数据库连接 | `mysql+pymysql://root:password@localhost:3306/universal_bi` |
| `REDIS_URL` | Redis 缓存连接 | `redis://localhost:6379/0` |
| `QWEN_MODEL` | 使用的 Qwen 模型 | `qwen-max` |

### AI 模型配置

- **DASHSCOPE_API_KEY**：从 [阿里云控制台](https://dashscope.console.aliyun.com/apiKey) 获取
- **QWEN_MODEL**：推荐使用 `qwen-max` 以获得更稳定的 SQL 生成效果

### 数据库配置

支持多种数据库：
```env
# MySQL
SQLALCHEMY_DATABASE_URI=mysql+pymysql://root:password@localhost:3306/universal_bi?charset=utf8mb4

# PostgreSQL
SQLALCHEMY_DATABASE_URI=postgresql://postgres:password@localhost:5432/universal_bi

# SQLite（开发用）
SQLALCHEMY_DATABASE_URI=sqlite:///./sql_app.db
```

**Section sources**
- [.env.example](file://.env.example#L1-L72)
- [config.py](file://backend/app/core/config.py#L5-L51)

## Docker Compose 部署

使用 `docker-compose.yml` 可一键启动所有服务。

### 服务组成

```mermaid
graph TB
subgraph "Universal BI 服务"
Backend[后端 API 服务]
Frontend[前端 Web 服务]
MySQL[MySQL 数据库]
PostgreSQL[PostgreSQL 向量库]
Redis[Redis 缓存]
end
Frontend --> Backend
Backend --> MySQL
Backend --> PostgreSQL
Backend --> Redis
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L141)

### 启动步骤

1. 确保已安装 Docker 和 Docker Compose
2. 创建并编辑 `.env` 文件
3. 启动服务：
```bash
docker-compose up -d
```
4. 查看日志：
```bash
docker-compose logs -f
```

### 服务端口映射

| 服务 | 容器端口 | 主机端口 | 用途 |
|------|----------|----------|------|
| 前端 | 80 | 3000 | Web 界面 |
| 后端 | 8000 | 8000 | API 服务 |
| MySQL | 3306 | 3306 | 主数据库 |
| PostgreSQL | 5432 | 5432 | 向量数据库 |
| Redis | 6379 | 6379 | 缓存服务 |

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L141)
- [Dockerfile.backend](file://Dockerfile.backend#L1-L40)
- [Dockerfile.frontend](file://Dockerfile.frontend#L1-L38)

## 手动开发环境搭建

适用于本地开发调试。

### Python 环境配置

```bash
cd backend
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
```

### 前端环境配置

```bash
cd frontend
npm install --registry=https://registry.npmmirror.com
```

### 依赖包说明

**后端依赖 (requirements.txt):**
- `fastapi`, `uvicorn`: Web 框架
- `sqlalchemy`, `pymysql`, `psycopg2-binary`: 数据库 ORM 和驱动
- `vanna`, `openai`, `chromadb`: AI 引擎相关
- `redis`: 缓存支持

**前端依赖 (package.json):**
- `vue`, `vue-router`, `pinia`: 核心框架
- `element-plus`: UI 组件库
- `echarts`, `vue-echarts`: 图表库
- `axios`: HTTP 客户端

**Section sources**
- [requirements.txt](file://requirements.txt#L1-L15)
- [package.json](file://frontend/package.json#L1-L40)

## 服务启动

### 开发模式启动

#### 方式一：使用启动脚本
```bash
bash start_dev.sh
```

#### 方式二：分别启动
```bash
# 启动后端
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 启动前端
cd frontend
npm run dev
```

### 访问地址

- **前端页面**: http://localhost:3000
- **后端 API**: http://localhost:8000
- **API 文档**: http://localhost:8000/docs
- **默认管理员**: 用户名 `admin`，密码 `admin123`

### 初始化数据库

首次部署需初始化数据库：
```bash
cd backend
python init_db.py
```
此脚本会创建所有数据表并添加默认管理员账户。

```mermaid
flowchart TD
Start([开始]) --> CheckEnv["检查环境依赖"]
CheckEnv --> InstallDeps["安装 Python/Node.js 依赖"]
InstallDeps --> CreateEnv["创建 .env 配置文件"]
CreateEnv --> InitDB["执行 init_db.py 初始化数据库"]
InitDB --> StartBackend["启动 FastAPI 后端"]
StartBackend --> StartFrontend["启动 Vue 前端"]
StartFrontend --> Complete([开发环境就绪])
```

**Diagram sources**
- [init_db.py](file://backend/init_db.py#L1-L79)
- [main.py](file://backend/app/main.py#L1-L35)

**Section sources**
- [init_db.py](file://backend/init_db.py#L1-L79)
- [main.py](file://backend/app/main.py#L1-L35)

## 常见问题排查

### 端口冲突

**症状**: 服务无法启动，提示端口被占用

**解决方案**:
```bash
# 检查端口占用
lsof -i :8000  # Linux/Mac
netstat -ano | findstr :8000  # Windows

# 修改 .env 中的端口配置
BACKEND_PORT=8001
FRONTEND_PORT=3001
```

### 依赖版本不兼容

**症状**: `pip install` 或 `npm install` 失败

**解决方案**:
```bash
# 清理缓存
pip cache purge
npm cache clean --force

# 重新安装
rm -rf backend/venv
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

cd frontend
rm -rf node_modules package-lock.json
npm install
```

### Docker 容器启动失败

**症状**: `docker-compose up` 后容器立即退出

**排查步骤**:
```bash
# 查看容器状态
docker-compose ps

# 查看详细日志
docker-compose logs backend
docker-compose logs mysql

# 重新构建并启动
docker-compose down
docker-compose up -d --build
```

### 数据库连接失败

**检查步骤**:
```bash
# 检查 .env 配置
grep SQLALCHEMY_DATABASE_URI .env

# 测试数据库连接
mysql -h localhost -u root -p  # 进入 MySQL
psql -h localhost -U postgres  # 进入 PostgreSQL
```

### Redis 连接问题

```bash
# 测试 Redis 连接
redis-cli ping  # 应返回 PONG

# 检查 Redis 配置
grep REDIS_URL .env
```

**Section sources**
- [README.md](file://README.md#L284-L356)
- [QUICKSTART.md](file://QUICKSTART.md#L192-L252)

## 总结

本指南提供了 Universal BI 项目的完整开发环境搭建方案。推荐使用 `setup.sh` 或 `setup.bat` 一键部署，或通过 Docker Compose 快速启动。关键步骤包括配置 `.env` 文件、安装依赖、初始化数据库和启动服务。遇到问题时，可参考常见问题排查方案。

**Section sources**
- [README.md](file://README.md#L1-L507)
- [QUICKSTART.md](file://QUICKSTART.md#L1-L274)