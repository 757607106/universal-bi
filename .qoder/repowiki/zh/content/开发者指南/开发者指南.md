# 开发者指南

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [QUICKSTART.md](file://QUICKSTART.md)
- [setup.sh](file://setup.sh)
- [backend/app/main.py](file://backend/app/main.py)
- [backend/app/core/config.py](file://backend/app/core/config.py)
- [backend/app/api/v1/endpoints/chat.py](file://backend/app/api/v1/endpoints/chat.py)
- [frontend/vite.config.ts](file://frontend/vite.config.ts)
- [frontend/tsconfig.json](file://frontend/tsconfig.json)
- [frontend/src/api/chat.ts](file://frontend/src/api/chat.ts)
- [frontend/src/utils/http/index.ts](file://frontend/src/utils/http/index.ts)
- [backend/tests/test_training_flow.py](file://backend/tests/test_training_flow.py)
- [.env.example](file://.env.example)
- [docker-compose.yml](file://docker-compose.yml)
- [backend/scripts/generate_fake_data.py](file://backend/scripts/generate_fake_data.py)
- [backend/requirements.txt](file://backend/requirements.txt)
- [frontend/package.json](file://frontend/package.json)
</cite>

## 目录
1. [本地开发环境搭建](#本地开发环境搭建)
2. [代码规范与静态分析](#代码规范与静态分析)
3. [测试流程](#测试流程)
4. [贡献流程](#贡献流程)
5. [调试技巧](#调试技巧)
6. [架构扩展指南](#架构扩展指南)

## 本地开发环境搭建

本项目支持两种部署方式：Docker 容器化部署和本地手动部署。对于贡献者，推荐使用开发模式进行本地开发。

### 开发环境准备

首先确保系统已安装以下基础软件：
- Python 3.8+
- Node.js 16+
- MySQL 5.7+ 或 PostgreSQL 12+
- Redis 5.0+

可通过以下命令验证：
```bash
python3 --version
node --version
mysql --version
redis-cli --version
```

### 一键部署脚本

项目提供 `setup.sh` 脚本用于自动化部署，支持开发模式和 Docker 模式。

**开发模式部署**：
```bash
# 克隆项目
git clone https://github.com/757607106/universal-bi.git
cd universal-bi

# 执行一键部署脚本
bash setup.sh dev
```

该脚本将自动完成以下操作：
1. 安装后端 Python 依赖
2. 安装前端 Node.js 依赖
3. 创建 `.env` 配置文件
4. 生成启动脚本 `start_dev.sh`

**Docker 模式部署**：
```bash
# 执行 Docker 部署
bash setup.sh docker
```

### 环境配置

复制环境变量模板并编辑：
```bash
cp .env.example .env
vi .env
```

**必须配置的环境变量**：
- `DASHSCOPE_API_KEY`：通义千问 API Key（必填）
- `SQLALCHEMY_DATABASE_URI`：数据库连接字符串
- `REDIS_URL`：Redis 缓存服务地址

### 启动开发服务器

#### 后端开发服务器（热重载）

后端使用 FastAPI 框架，通过 uvicorn 启动开发服务器并启用热重载功能：

```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

或使用生成的启动脚本：
```bash
bash start_dev.sh
```

后端服务将运行在 `http://localhost:8000`，API 文档可在 `http://localhost:8000/docs` 查看。

#### 前端开发服务器（热重载）

前端使用 Vite 构建工具，提供快速的热重载开发体验：

```bash
cd frontend
npm run dev
```

前端服务将运行在 `http://localhost:3000`。

**Vite 代理配置**：
`vite.config.ts` 中配置了代理，将 `/api` 请求转发到后端服务：
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true
    }
  }
}
```

**Section sources**
- [setup.sh](file://setup.sh)
- [backend/app/main.py](file://backend/app/main.py)
- [frontend/vite.config.ts](file://frontend/vite.config.ts)
- [.env.example](file://.env.example)
- [docker-compose.yml](file://docker-compose.yml)

## 代码规范与静态分析

### Python 代码规范

后端使用 Python 编写，遵循 PEP 8 代码规范。项目使用以下工具进行代码格式化和静态分析：

- **Black**：代码格式化工具
- **isort**：导入排序工具
- **flake8**：代码风格检查
- **mypy**：类型检查

安装开发依赖：
```bash
cd backend
pip install black isort flake8 mypy
```

执行代码格式化：
```bash
# 格式化代码
black .

# 排序导入
isort .

# 代码风格检查
flake8

# 类型检查
mypy .
```

### TypeScript 代码规范

前端使用 TypeScript 编写，配置了严格的类型检查。相关配置在 `tsconfig.json` 中定义。

**TypeScript 配置要点**：
- `"strict": true`：启用所有严格类型检查选项
- `"esModuleInterop": true`：允许 CommonJS 和 ES 模块之间的互操作
- `"allowSyntheticDefaultImports": true`：允许从没有默认导出的模块进行默认导入
- `"sourceMap": true`：生成 sourcemap 文件用于调试

### 代码格式化工具

项目使用 Prettier 统一前端代码格式：

```bash
# 安装 Prettier
npm install --save-dev prettier

# 格式化代码
npx prettier --write "src/**/*.{ts,vue}"
```

**Prettier 配置**：
- 使用默认配置
- 支持 Vue 和 TypeScript 文件
- 与 ESLint 集成（如有）

### 静态分析配置

#### 后端静态分析

`pyproject.toml` 或 `setup.cfg` 中配置了代码检查规则，包括：
- 代码复杂度检查
- 安全漏洞扫描
- 依赖版本检查

#### 前端静态分析

`package.json` 中定义了 lint 脚本：
```json
"scripts": {
  "lint": "eslint src --ext .ts,.vue",
  "format": "prettier --write \"src/**/*.{ts,vue}\""
}
```

**Section sources**
- [backend/app/core/config.py](file://backend/app/core/config.py)
- [frontend/tsconfig.json](file://frontend/tsconfig.json)
- [backend/requirements.txt](file://backend/requirements.txt)
- [frontend/package.json](file://frontend/package.json)

## 测试流程

### 后端测试结构

测试文件位于 `backend/tests/` 目录下，采用分层结构：

```
backend/tests/
├── manual_scripts/           # 手动测试脚本
│   ├── test_admin_features.py
│   ├── test_logout.py
│   ├── test_multi_round.py
│   ├── test_redis_cache.py
│   └── test_token_blacklist.sh
├── test_analyst_agent.py     # 分析代理测试
├── test_feedback_rlhf.py     # 反馈强化学习测试
├── test_new_fields.py        # 新字段测试
├── test_schema_injection.py  # 模式注入测试
├── test_training_api.py      # 训练API测试
├── test_training_control.py  # 训练控制测试
└── test_training_flow.py     # 训练流程测试
```

### 单元测试执行

使用 `pytest` 运行单元测试：

```bash
cd backend
# 安装测试依赖
pip install pytest pytest-asyncio requests

# 运行所有测试
pytest tests/

# 运行特定测试文件
pytest tests/test_training_flow.py

# 运行测试并显示详细输出
pytest -v tests/
```

### 手动脚本测试

`manual_scripts/` 目录包含用于验证特定功能的手动测试脚本：

- `test_redis_cache.py`：验证 Redis 缓存功能
- `test_token_blacklist.sh`：验证 JWT 黑名单机制
- `test_admin_features.py`：验证管理员功能

执行手动测试脚本：
```bash
cd backend/tests/manual_scripts
python test_redis_cache.py
```

### 测试示例：训练流程测试

`test_training_flow.py` 验证了完整的 Dataset 训练流程：

```python
def test_flow():
    # 1. 创建/检查数据源
    # 2. 获取数据表
    # 3. 创建 Dataset
    # 4. 更新 Schema（选择表）
    # 5. 触发训练
    # 6. 轮询状态直到完成
```

该测试通过 HTTP 请求与 API 交互，验证端到端功能。

### 前端 API 封装测试

前端 API 封装位于 `src/api/` 目录，每个模块对应一个 API 端点：

```
frontend/src/api/
├── chat.ts
├── dashboard.ts
├── dataset.ts
├── datasource.ts
├── system.ts
└── user.ts
```

#### API 封装修改

以 `chat.ts` 为例，修改 API 封装：

```typescript
export const sendChat = async (data: { dataset_id: number, question: string }) => {
  const responseData = await http.post<any, { dataset_id: number, question: string }>('/chat/', data)
  return {
    answer_text: responseData.answer_text || responseData.summary,
    sql: responseData.sql,
    columns: responseData.columns,
    rows: responseData.rows,
    data: null,
    chart_type: responseData.chart_type,
    steps: responseData.steps || [],
    from_cache: responseData.from_cache || false,
    insight: responseData.insight
  } as ChatResponse
}
```

#### API 测试方法

1. **单元测试**：使用 Jest 测试 API 函数
2. **集成测试**：启动后端服务，测试真实 API 调用
3. **手动测试**：在浏览器中验证功能

创建测试用例：
```typescript
// tests/api/chat.test.ts
import { sendChat } from '@/api/chat'

describe('Chat API', () => {
  test('should send chat message', async () => {
    const result = await sendChat({ dataset_id: 1, question: '测试问题' })
    expect(result).toHaveProperty('sql')
  })
})
```

**Section sources**
- [backend/tests/test_training_flow.py](file://backend/tests/test_training_flow.py)
- [frontend/src/api/chat.ts](file://frontend/src/api/chat.ts)
- [frontend/src/utils/http/index.ts](file://frontend/src/utils/http/index.ts)

## 贡献流程

### Pull Request 提交标准

提交 Pull Request 时需遵守以下标准：

1. **代码质量**：
   - 通过所有静态分析检查
   - 通过所有测试用例
   - 符合代码风格规范

2. **文档更新**：
   - 更新相关文档
   - 添加必要的注释
   - 更新类型定义（如适用）

3. **测试覆盖**：
   - 新功能必须包含单元测试
   - 修复 bug 必须包含回归测试
   - 测试覆盖率不低于 80%

4. **提交信息**：
   - 使用清晰、描述性的提交信息
   - 遵循约定式提交规范
   - 包含相关 issue 编号（如有）

### 分支管理策略

采用 Git Flow 分支模型：

- `main`：主分支，保护分支，仅通过 PR 合并
- `develop`：开发分支，集成所有功能
- `feature/*`：功能分支，命名如 `feature/user-auth`
- `bugfix/*`：修复分支，命名如 `bugfix/login-issue`
- `release/*`：发布分支，用于版本发布

**工作流程**：
```bash
# 1. 从 develop 分支创建功能分支
git checkout develop
git checkout -b feature/new-api

# 2. 开发功能
# ... 修改代码 ...

# 3. 提交更改
git add .
git commit -m "feat: add new API endpoint"

# 4. 推送到远程
git push origin feature/new-api

# 5. 创建 Pull Request 到 develop 分支
```

### 代码审查流程

1. **自动检查**：
   - CI/CD 流水线运行测试和静态分析
   - 代码覆盖率检查
   - 安全扫描

2. **人工审查**：
   - 至少一名核心成员审查
   - 关注代码质量、设计模式、安全性
   - 提供建设性反馈

3. **合并条件**：
   - 所有检查通过
   - 至少一个批准
   - 分支最新（无冲突）

**Section sources**
- [README.md](file://README.md)
- [QUICKSTART.md](file://QUICKSTART.md)

## 调试技巧

### FastAPI 日志输出

FastAPI 提供详细的日志输出，有助于调试：

1. **启用详细日志**：
```bash
uvicorn app.main:app --reload --log-level debug
```

2. **查看请求日志**：
```
INFO:     127.0.0.1:54321 - "POST /api/v1/chat/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:54322 - "GET /api/v1/datasets/ HTTP/1.1" 200 OK
```

3. **自定义日志**：
```python
import logging
logger = logging.getLogger(__name__)

@app.post("/")
async def chat():
    logger.debug(f"Received request: {request}")
    # ... 处理逻辑 ...
    logger.info("Chat request processed successfully")
```

### Vue Devtools 使用

Vue Devtools 是调试 Vue 应用的强大工具：

1. **安装 Vue Devtools**：
   - Chrome 浏览器扩展
   - Firefox 浏览器扩展

2. **主要功能**：
   - **组件树**：查看组件层次结构
   - **状态检查**：查看组件 props、data、computed
   - **事件追踪**：监控组件事件
   - **性能分析**：分析组件渲染性能

3. **调试技巧**：
   - 使用 `$vm0` 在控制台访问当前选中组件
   - 监控 Vuex/Pinia 状态变化
   - 调试响应式数据变化

### 前后端联调

1. **网络请求调试**：
   - 使用浏览器开发者工具的 Network 面板
   - 查看 API 请求和响应
   - 检查请求头、状态码、响应体

2. **错误处理**：
   - 前端统一错误处理在 `src/utils/http/index.ts`
   - 根据 HTTP 状态码进行相应处理
   - 401 状态码自动跳转登录页

3. **缓存调试**：
   - 检查 Redis 缓存命中情况
   - 使用 `monitor_redis.py` 监控 Redis 操作

**Section sources**
- [backend/app/main.py](file://backend/app/main.py)
- [frontend/src/utils/http/index.ts](file://frontend/src/utils/http/index.ts)

## 架构扩展指南

### 新增 API 端点

遵循现有架构模式新增 API 端点：

1. **创建端点文件**：
```bash
# 在对应目录创建新文件
touch backend/app/api/v1/endpoints/new_feature.py
```

2. **定义路由**：
```python
from fastapi import APIRouter

router = APIRouter()

@router.get("/")
def read_new_feature():
    return {"message": "New feature"}
```

3. **注册路由**：
在 `backend/app/main.py` 中导入并注册：
```python
from app.api.v1.endpoints import new_feature

app.include_router(new_feature.router, prefix=f"{settings.API_V1_STR}/new-feature", tags=["new-feature"])
```

4. **添加依赖**：
- 数据库会话：`db: Session = Depends(get_db)`
- 用户认证：`current_user: User = Depends(get_current_user)`
- 权限控制：`apply_ownership_filter`

### 新增 UI 组件

遵循 Vue 3 + TypeScript 模式新增组件：

1. **创建组件文件**：
```bash
# 在对应目录创建新组件
mkdir -p frontend/src/components/NewFeature
touch frontend/src/components/NewFeature/index.vue
```

2. **组件结构**：
```vue
<script setup lang="ts">
// 类型定义
interface Props {
  title: string
}

// Props
defineProps<Props>()

// 事件
const emit = defineEmits(['update']>()
</script>

<template>
  <div class="new-feature">
    <h2>{{ title }}</h2>
  </div>
</template>

<style scoped>
.new-feature {
  @apply p-4 border rounded;
}
</style>
```

3. **注册组件**：
在 `components/index.ts` 中导出：
```typescript
export { default as NewFeature } from './NewFeature/index.vue'
```

4. **使用组件**：
```vue
<script setup lang="ts">
import { NewFeature } from '@/components'
</script>

<template>
  <NewFeature title="新功能" />
</template>
```

**Section sources**
- [backend/app/main.py](file://backend/app/main.py)
- [frontend/src/components/](file://frontend/src/components/)