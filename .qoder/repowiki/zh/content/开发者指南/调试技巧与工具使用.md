# 调试技巧与工具使用

<cite>
**本文档引用的文件**   
- [main.py](file://backend/app/main.py)
- [auth.py](file://backend/app/api/v1/endpoints/auth.py)
- [security.py](file://backend/app/core/security.py)
- [config.py](file://backend/app/core/config.py)
- [session.py](file://backend/app/db/session.py)
- [index.ts](file://frontend/src/utils/http/index.ts)
- [vanna_manager.py](file://backend/app/services/vanna_manager.py)
- [dataset.py](file://backend/app/api/v1/endpoints/dataset.py)
- [monitor_redis.py](file://backend/monitor_redis.py)
- [test_redis_cache.py](file://backend/tests/manual_scripts/test_redis_cache.py)
</cite>

## 目录
1. [简介](#简介)
2. [后端调试技巧](#后端调试技巧)
3. [前端调试技巧](#前端调试技巧)
4. [前后端通信调试](#前后端通信调试)
5. [缓存与数据库调试](#缓存与数据库调试)
6. [常见错误排查](#常见错误排查)
7. [总结](#总结)

## 简介
本指南旨在为开发者提供一套完整的调试技巧与工具使用方法，帮助快速定位和解决在开发 Universal BI 平台过程中遇到的问题。文档涵盖了从后端 FastAPI 日志输出、前端 Vue Devtools 使用，到 Redis 缓存监控和数据库数据验证的全方位调试策略。

## 后端调试技巧

### 启用FastAPI日志输出
在 FastAPI 应用中，可以通过 Python 的 logging 模块来启用详细的日志输出。在 `backend/app/main.py` 中，应用已经配置了基本的日志功能。开发者可以通过添加日志语句来追踪请求的生命周期和关键服务调用。

```python
import logging

logger = logging.getLogger(__name__)

@app.get("/")
def root():
    logger.info("根路径被访问")
    return {"message": "Welcome to Universal BI API"}
```

通过在关键函数和方法中添加 `logger.info()`、`logger.debug()` 或 `logger.error()` 语句，可以记录应用的运行状态和错误信息，帮助追踪问题。

**Section sources**
- [main.py](file://backend/app/main.py#L1-L35)

### 使用Python logging模块追踪请求
在 `backend/app/core/security.py` 文件中，可以看到如何使用 logging 模块来记录安全相关的操作，如 JWT 令牌的黑名单管理。通过在关键路径上添加日志记录，可以清晰地看到认证流程的每一步。

```python
logger = logging.getLogger(__name__)

def add_token_to_blacklist(token: str) -> bool:
    logger.info(f"将 Token 添加到黑名单，TTL: {ttl}s")
    # ... 其他代码
```

这种细粒度的日志记录对于调试认证失败或令牌管理问题非常有帮助。

**Section sources**
- [security.py](file://backend/app/core/security.py#L1-L161)

## 前端调试技巧

### 使用Vue Devtools检查组件状态
Vue Devtools 是一个强大的浏览器扩展，用于调试 Vue.js 应用。它可以让你检查组件的层次结构、查看和修改组件的状态（data）、监听事件以及查看计算属性和监听器。

在 Universal BI 的前端应用中，可以通过 Vue Devtools 来检查如 `DynamicChart.vue` 或 `MainLayout.vue` 等组件的状态，确保数据正确传递和渲染。

### 检查事件流与API请求响应
通过 Vue Devtools 的 "Events" 面板，可以监听组件间触发的自定义事件，这对于理解复杂的用户交互流程非常有用。同时，结合浏览器的开发者工具的 "Network" 面板，可以检查所有 API 请求的请求头、响应体和状态码，确保前后端通信正常。

## 前后端通信调试

### 添加请求/响应拦截器进行调试
在 `frontend/src/utils/http/index.ts` 文件中，定义了一个 `PureHttp` 类，它使用 Axios 的拦截器来处理请求和响应。开发者可以在此处添加调试代码，以监控所有进出前端的 HTTP 通信。

```typescript
private httpInterceptorsRequest(): void {
    PureHttp.axiosInstance.interceptors.request.use(
        async (config: any) => {
            NProgress.start();
            const token = getToken();
            if (token) {
                config.headers["Authorization"] = `Bearer ${token}`;
            }
            console.log("请求配置:", config); // 调试：打印请求配置
            return config;
        },
        error => {
            return Promise.reject(error);
        }
    );
}

private httpInterceptorsResponse(): void {
    PureHttp.axiosInstance.interceptors.response.use(
        (response: any) => {
            NProgress.done();
            console.log("响应数据:", response.data); // 调试：打印响应数据
            return response.data;
        },
        (error: AxiosError) => {
            NProgress.done();
            console.error("HTTP 错误:", error);
            return Promise.reject(error);
        }
    );
}
```

通过在拦截器中添加 `console.log` 语句，可以实时查看每个请求和响应的详细信息，这对于调试 API 调用问题非常有效。

**Section sources**
- [index.ts](file://frontend/src/utils/http/index.ts#L1-L173)

## 缓存与数据库调试

### 使用Redis CLI监控缓存状态
Redis 被用于缓存查询结果和管理 JWT 令牌的黑名单。可以使用 `monitor_redis.py` 脚本来实时监控 Redis 中的键值变化。

```bash
# 运行监控脚本
python backend/monitor_redis.py

# 或直接使用 redis-cli
redis-cli
> monitor
```

`monitor` 命令会实时输出所有在 Redis 服务器上执行的命令，这对于观察缓存的读写操作和令牌的黑名单添加非常有用。

### 通过数据库客户端检查数据所有权
在多租户系统中，确保数据的所有权（owner_id）正确应用至关重要。在 `backend/app/api/v1/endpoints/dataset.py` 中，可以看到 `apply_ownership_filter` 函数被用于在查询中自动添加所有权过滤。

```python
def list_datasets(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    query = db.query(Dataset)
    query = apply_ownership_filter(query, Dataset, current_user)  # 应用数据隔离
    datasets = query.offset(skip).limit(limit).all()
    return datasets
```

使用数据库客户端（如 MySQL Workbench 或 pgAdmin）直接查询数据库，检查 `datasets` 表中的 `owner_id` 字段，确保普通用户只能看到自己的数据集，而超级管理员可以看到所有数据。

**Section sources**
- [dataset.py](file://backend/app/api/v1/endpoints/dataset.py#L1-L800)

## 常见错误排查

### JWT认证失败
JWT 认证失败通常由以下原因引起：
1. **令牌过期**：检查 `settings.ACCESS_TOKEN_EXPIRE_MINUTES` 的配置。
2. **签名密钥不匹配**：确保 `settings.SECRET_KEY` 在所有服务中一致。
3. **令牌在黑名单中**：使用 `monitor_redis.py` 检查 Redis 中的 `blacklist:token:*` 键。

在 `auth.py` 的 `logout` 端点中，成功登出后会将令牌加入黑名单。如果 Redis 不可用，会返回警告但仍然成功，这是一种降级策略。

```python
def logout(
    token: str = Depends(reusable_oauth2),
    current_user: User = Depends(get_current_user)
):
    success = security.add_token_to_blacklist(token)
    # ... 处理成功或失败的情况
```

**Section sources**
- [auth.py](file://backend/app/api/v1/endpoints/auth.py#L1-L147)

### SQL生成错误
SQL 生成错误通常与 Vanna AI 模型的训练数据有关。在 `vanna_manager.py` 中，`train_dataset` 方法负责将数据库的 DDL 和业务术语训练到 Vanna 模型中。

```python
@staticmethod
async def train_dataset_async(dataset_id: int, table_names: list[str], db_session: Session):
    # ... 训练 DDL、业务术语和生成示例
    vn.train(ddl=ddl)
    vn.train(documentation=doc_content)
    vn.train(question=question, sql=sql)
```

如果生成的 SQL 有语法错误或逻辑错误，应检查：
1. **DDL 是否正确**：确保 `DBInspector.get_table_ddl()` 返回的 DDL 是准确的。
2. **业务术语是否清晰**：模糊的术语定义可能导致 AI 误解。
3. **示例 QA 对是否足够**：增加更多高质量的示例可以提高 SQL 生成的准确性。

**Section sources**
- [vanna_manager.py](file://backend/app/services/vanna_manager.py#L1-L800)

## 总结
通过综合运用日志记录、前端工具、网络拦截器和数据库监控，开发者可以高效地调试 Universal BI 平台。关键在于理解系统的各个组件如何交互，并利用合适的工具来观察和分析这些交互。遵循本文档中的技巧，可以显著缩短问题定位和解决的时间。